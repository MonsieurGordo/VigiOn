<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VigiOn – Painel de Permissões</title>
    <!-- Tailwind CSS para estilização e responsividade -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonte Poppins para consistência com a tela de login -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos globais para o corpo e HTML */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Poppins', sans-serif;
            background-color: #f0f2f5; /* Fundo claro para a tela */
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto; /* Permite rolagem se o conteúdo exceder a altura */
        }

        /* Cores personalizadas (consistentes com o VigiOn) */
        .custom-bg-primary { background-color: #6200EE; } /* Primária: Roxo */
        .custom-bg-secondary { background-color: #5A73D4; } /* Secundária: Azul vibrante */
        .custom-text-primary { color: #6200EE; }
        .custom-text-secondary { color: #5A73D4; }

        /* Estilos para o Painel de Permissões (similar ao modal de cadastros) */
        .permissions-panel-container {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
            max-width: 98%; /* Aumenta um pouco a largura máxima */
            width: 1300px; /* Largura fixa maior para telas grandes */
            height: 95vh; /* Aumenta um pouco a altura */
            display: flex;
            flex-direction: column;
            margin: 1rem auto; /* Centraliza e adiciona margem */
        }

        /* Área de Conteúdo Principal */
        .main-content-area {
            display: flex;
            flex-direction: column;
            flex-grow: 1; /* Ocupa o espaço restante verticalmente */
        }

        .permissions-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #5A73D4;
            color: white;
            padding: 1rem 1.5rem;
            margin: -1.5rem -1.5rem 1.5rem -1.5rem; /* Ajusta margem para cobrir o padding do container */
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
        }
        .permissions-panel-header h3 {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
        }
        .permissions-panel-header button { /* Estilo para o botão "+ Adicionar" */
            background-color: #6200EE;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .permissions-panel-header button:hover {
            background-color: #5A73D4;
        }

        /* Estilos para filtros e tabela */
        .permissions-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem; /* Espaço abaixo da barra de pesquisa */
            align-items: center;
        }
        .permissions-filters input {
            flex-grow: 1;
            padding: 0.6rem 1rem;
            border: 1px solid #CBD5E0;
            border-radius: 0.5rem;
            font-size: 0.95rem;
            width: 100%; /* Ocupa toda a largura disponível */
        }
        .permissions-filters select {
            padding: 0.6rem 1rem;
            border: 1px solid #CBD5E0;
            border-radius: 0.5rem;
            font-size: 0.95rem;
            background-color: white;
        }

        /* Contêiner para o botão de filtro de colunas e popover */
        .column-filter-area {
            display: flex;
            justify-content: flex-end; /* Alinha o conteúdo à direita */
            margin-bottom: 1rem; /* Espaço entre o filtro e a tabela */
            position: relative; /* Para posicionar o popover */
            padding-right: 0.5rem; /* Pequeno padding para alinhar com a tabela */
        }

        .permissions-table-container {
            flex-grow: 1;
            height: 0; /* Adicionado para garantir que flex-grow e overflow-y funcionem corretamente */
            overflow-x: auto; /* Adiciona rolagem horizontal se a tabela for muito larga */
            overflow-y: auto;
            border: 1px solid #E2E8F0;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        .permissions-table {
            width: 100%;
            min-width: 1000px; /* Garante que a tabela não encolha demais, ajustado para mais colunas */
            border-collapse: collapse;
            font-size: 0.8rem; /* Fonte um pouco menor para caber mais colunas */
        }
        .permissions-table th, .permissions-table td {
            padding: 0.4rem 0.5rem; /* Reduz o padding para mais compactação */
            text-align: left;
            border-bottom: 1px solid #E2E8F0;
        }
        .permissions-table th {
            background-color: #F7FAFC;
            font-weight: 600;
            color: #4A5568;
            position: sticky;
            top: 0;
            z-index: 1;
            white-space: normal; /* Permite que o texto do cabeçalho quebre linha */
            max-width: 100px; /* Define uma largura máxima para forçar a quebra */
            text-align: center; /* Centraliza o texto do cabeçalho */
            vertical-align: middle; /* Centraliza verticalmente o cabeçalho */
        }
        .permissions-table td {
            vertical-align: middle; /* Centraliza verticalmente o conteúdo das células de dados */
        }
        .permissions-table tbody tr:hover {
            background-color: #F0F4F8;
        }
        .permissions-table .action-buttons { /* Adicionado estilo para a célula de botões de ação */
            text-align: center; /* CENTRALIZA OS BOTÕES DE AÇÃO */
        }
        .permissions-table .action-buttons button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.2rem; /* Reduz o padding dos botões de ação */
            border-radius: 0.375rem;
            transition: background-color 0.2s ease;
        }
        .permissions-table .action-buttons button:hover {
            background-color: #E2E8F0;
        }
        .permissions-table .action-buttons svg {
            width: 14px; /* Reduz o tamanho dos ícones de ação */
            height: 14px;
            color: #718096;
        }
        .permissions-table .permission-checkbox {
            width: 16px; /* Reduz o tamanho dos checkboxes */
            height: 16px;
            accent-color: #6200EE; /* Cor do checkbox */
            cursor: pointer;
            flex-shrink: 0; /* IMPEDE O CHECKBOX DE ENCOLHER */
        }
        /* Estilo para a célula do checkbox e texto SIM/NÃO */
        .permissions-table td.checkbox-cell {
            text-align: center; /* Centraliza o conteúdo (o label) dentro da célula */
        }
        .permissions-table td.checkbox-cell label { /* Estilo para o label que envolve checkbox e texto */
            display: flex; /* ALTERADO: Usar flex para melhor controle de alinhamento */
            align-items: center; /* Alinha itens verticalmente ao centro */
            justify-content: center; /* Centraliza o conteúdo horizontalmente dentro do label */
            gap: 0.25rem; /* Espaço entre o checkbox e o texto */
            width: 100%; /* Ocupa a largura total para centralizar */
            min-height: 24px; /* Adiciona uma altura mínima para consistência */
            box-sizing: border-box; /* Garante que padding e border sejam incluídos na altura/largura */
        }
        .permissions-table td.checkbox-cell label span {
            font-size: 0.75rem; /* Tamanho da fonte para SIM/NÃO */
            font-weight: 500;
            color: #4A5568;
            white-space: nowrap; /* Impede que o texto quebre linha */
            flex-shrink: 0; /* IMPEDE O TEXTO DE ENCOLHER */
        }

        .permissions-pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #718096;
        }
        .permissions-pagination-buttons button {
            background-color: #F7FAFC;
            border: 1px solid #E2E8F0;
            padding: 0.4rem 0.7rem; /* Preenchimento dos botões de paginação */
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin: 0 0.2rem;
        }
        .permissions-pagination-buttons button.active {
            background-color: #6200EE;
            color: white;
            border-color: #6200EE;
        }
        .permissions-pagination-buttons button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Rodapé do Painel de Permissões com o botão de fechar/voltar */
        .permissions-panel-footer {
            display: flex;
            justify-content: flex-end;
            padding-top: 0.75rem; /* Preenchimento superior do rodapé */
            border-top: 1px solid #E2E8F0;
            margin-top: auto;
            align-items: center;
        }
        .permissions-panel-footer .back-button {
            background-color: #F44336; /* Red color for exit button */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .permissions-panel-footer .back-button:hover {
            background-color: #D32F2F;
        }
        .permissions-panel-footer .back-button svg {
            width: 20px;
            height: 20px;
            color: white;
        }

        /* --- Estilo: Popover de Filtro de Colunas --- */
        .column-filter-popover {
            position: absolute;
            top: 100%; /* Abaixo do botão que o contém */
            right: 0; /* Alinha à direita do elemento pai (.column-filter-area) */
            background-color: white;
            border: 1px solid #E2E8F0;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 1rem;
            z-index: 100; /* Acima da tabela */
            min-width: 200px;
            display: none; /* Escondido por padrão */
            flex-direction: column;
            gap: 0.75rem;
            transform: translateY(0.5rem); /* Pequeno deslocamento para baixo */
        }
        .column-filter-popover.show {
            display: flex;
        }
        .column-filter-popover h4 {
            font-size: 1rem;
            font-weight: 600;
            color: #4A5568;
            margin-bottom: 0.5rem;
            text-align: center;
        }
        .column-filter-popover label {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            color: #2D3748;
            cursor: pointer;
        }
        .column-filter-popover input[type="checkbox"] {
            margin-right: 0.5rem;
            accent-color: #5A73D4;
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        .column-filter-popover input[type="checkbox"]:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Estilos para o botão de filtro */
        .filter-button {
            background: none;
            border: none;
            cursor: pointer;
            color: #4A5568;
            font-size: 1rem;
            padding: 0.2rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease;
            flex-shrink: 0; /* Evita que o botão encolha */
        }
        .filter-button:hover {
            background-color: #E2E8F0;
        }
        .filter-button svg {
            width: 18px;
            height: 18px;
        }


        /* Estilos para o Modal de Adição de Permissão (dentro desta nova tela) */
        .add-permission-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2001; /* Acima do painel */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .add-permission-modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .add-permission-modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            text-align: left;
            max-width: 500px;
            width: 90%;
            transform: translateY(-30px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .add-permission-modal-overlay.show .add-permission-modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .add-permission-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .add-permission-modal-header h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
            margin: 0;
        }
        .add-permission-modal-content label {
            font-weight: 500;
            color: #4A5568;
            margin-bottom: 0.4rem;
            display: block;
        }
        .add-permission-modal-content input[type="text"],
        .add-permission-modal-content select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #CBD5E0;
            border-radius: 0.5rem;
            font-size: 1rem;
            box-sizing: border-box;
            margin-bottom: 1rem;
        }
        .add-permission-modal-content input:focus,
        .add-permission-modal-content select:focus {
            outline: none;
            border-color: #6200EE;
            box-shadow: 0 0 0 3px rgba(98, 0, 238, 0.2);
        }
        .add-permission-modal-content .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .add-permission-modal-content .checkbox-group label {
            display: flex;
            align-items: center;
            margin-bottom: 0;
            cursor: pointer;
        }
        .add-permission-modal-content .checkbox-group input[type="checkbox"] {
            margin-right: 0.75rem;
            accent-color: #6200EE;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .add-permission-modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 1rem;
        }
        .add-permission-modal-buttons button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .add-permission-modal-buttons button.cancel-btn {
            background-color: #E2E8F0;
            color: #2D3748;
        }
        .add-permission-modal-buttons button.cancel-btn:hover {
            background-color: #CBD5E0;
        }
        .add-permission-modal-buttons button.save-btn {
            background-color: #6200EE;
            color: white;
        }
        .add-permission-modal-buttons button.save-btn:hover {
            background-color: #5A73D4;
        }
        @media (max-width: 640px) {
            .add-permission-modal-content {
                padding: 1rem;
                width: 95%;
            }
            .add-permission-modal-header h3 {
                font-size: 1.3rem;
            }
            .add-permission-modal-buttons {
                flex-direction: column;
                gap: 0.5rem;
            }
            .add-permission-modal-buttons button {
                width: 100%;
            }
        }

        /* Modal para Mensagens de Erro/Validação (AGORA COM OPÇÃO DE CANCELAR) */
        .message-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000; /* Z-index mais alto para garantir que apareça sobre tudo */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .message-modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .message-modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
            text-align: center;
            max-width: 450px;
            width: 90%;
            transform: translateY(-30px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .message-modal-overlay.show .message-modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .message-modal-content h3 {
            color: #333;
        }
        .message-modal-content p {
            color: #555;
        }
        .message-modal-buttons-group { /* Novo grupo para os botões do modal de mensagem */
            display: flex;
            justify-content: center;
            gap: 1rem; /* Espaçamento entre os botões */
            margin-top: 1.5rem;
        }
        .message-modal-buttons-group button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
        }
        .message-modal-buttons-group .ok-button {
            background-color: #6200EE;
            color: white;
        }
        .message-modal-buttons-group .ok-button:hover {
            background-color: #5A73D4;
        }
        .message-modal-buttons-group .cancel-button {
            background-color: #E2E8F0;
            color: #2D3748;
        }
        .message-modal-buttons-group .cancel-button:hover {
            background-color: #CBD5E0;
        }


        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 4000; /* Acima de todos os outros modais */
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
            display: none; /* Escondido por padrão */
        }
        .loading-overlay.show {
            display: flex;
        }

        /* Novo Modal de Visualização/Edição de Permissão */
        .view-edit-permission-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2002; /* Acima do modal de adicionar, mas abaixo do de mensagem */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .view-edit-permission-modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .view-edit-permission-modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            text-align: left;
            max-width: 500px;
            width: 90%;
            transform: translateY(-30px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .view-edit-permission-modal-overlay.show .view-edit-permission-modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .view-edit-permission-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .view-edit-permission-modal-header h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
            margin: 0;
        }
        .view-edit-permission-modal-content label {
            font-weight: 500;
            color: #4A5568;
            margin-bottom: 0.4rem;
            display: block;
        }
        .view-edit-permission-modal-content input[type="text"],
        .view-edit-permission-modal-content select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #CBD5E0;
            border-radius: 0.5rem;
            font-size: 1rem;
            box-sizing: border-box;
            margin-bottom: 1rem;
            background-color: white; /* Garante fundo branco mesmo quando desabilitado */
        }
        .view-edit-permission-modal-content input[type="text"]:disabled,
        .view-edit-permission-modal-content select:disabled {
            background-color: #F7FAFC; /* Cor de fundo para campos desabilitados */
            color: #718096; /* Cor do texto para campos desabilitados */
            cursor: not-allowed;
        }
        .view-edit-permission-modal-content input:focus,
        .view-edit-permission-modal-content select:focus {
            outline: none;
            border-color: #6200EE;
            box-shadow: 0 0 0 3px rgba(98, 0, 238, 0.2);
        }
        .view-edit-permission-modal-content .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .view-edit-permission-modal-content .checkbox-group label {
            display: flex;
            align-items: center;
            margin-bottom: 0;
            cursor: pointer;
        }
        .view-edit-permission-modal-content .checkbox-group input[type="checkbox"] {
            margin-right: 0.75rem;
            accent-color: #6200EE;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .view-edit-permission-modal-content .checkbox-group input[type="checkbox"]:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .view-edit-permission-modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 1rem;
        }
        .view-edit-permission-modal-buttons button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .view-edit-permission-modal-buttons button.cancel-btn {
            background-color: #E2E8F0;
            color: #2D3748;
        }
        .view-edit-permission-modal-buttons button.cancel-btn:hover {
            background-color: #CBD5E0;
        }
        .view-edit-permission-modal-buttons button.update-btn { /* Botão de Atualizar */
            background-color: #6200EE;
            color: white;
        }
        .view-edit-permission-modal-buttons button.update-btn:hover {
            background-color: #5A73D4;
        }
        @media (max-width: 640px) {
            .view-edit-permission-modal-content {
                padding: 1rem;
                width: 95%;
            }
            .view-edit-permission-modal-header h3 {
                font-size: 1.3rem;
            }
            .view-edit-permission-modal-buttons {
                flex-direction: column;
                gap: 0.5rem;
            }
            .view-edit-permission-modal-buttons button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="permissions-panel-container">
        <!-- Área de Conteúdo Principal -->
        <div class="main-content-area">
            <div class="permissions-panel-header">
                <h3>Painel de Permissões</h3>
                <button id="addPermissionButton">+ Adicionar</button>
            </div>
            
            <div class="permissions-filters">
                <input type="text" id="searchPermissionInput" placeholder="Pesquisar por tipo de acesso ou empresa..." />
            </div>

            <!-- Contêiner para o botão de filtro de colunas e popover -->
            <div class="column-filter-area">
                <button id="toggleColumnFilterButton" class="filter-button" title="Filtrar Colunas">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.78 1.35a2 2 0 0 0 .73 2.73l.04.02a2 2 0 0 1 .97 1.95v.44a2 2 0 0 1-.97 1.95l-.04.02a2 2 0 0 0-.73 2.73l.78 1.35a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.78-1.35a2 2 0 0 0-.73-2.73l-.04-.02a2 2 0 0 1-.97-1.95v-.44a2 2 0 0 1 .97-1.95l-.04-.02a2 2 0 0 0 .73-2.73l-.78-1.35a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                </button>
                <div id="columnFilterPopover" class="column-filter-popover">
                    <h4>Ocultar Colunas</h4>
                    <div class="checkbox-group" id="columnVisibilityCheckboxes">
                        <!-- Checkboxes serão gerados aqui via JS -->
                    </div>
                </div>
            </div>

            <div class="permissions-table-container">
                <table class="permissions-table">
                    <thead>
                        <tr>
                            <th data-column-id="company">EMPRESA</th>
                            <th data-column-id="accessType">TIPO DE ACESSO</th>
                            <th data-column-id="viewMap">VISUALIZAR MAPA</th>
                            <th data-column-id="locateTeam">LOCALIZAR EQUIPE</th>
                            <th data-column-id="viewHistory">HISTÓRICO</th>
                            <th data-column-id="printHistory">IMPRIMIR HISTÓRICO</th>
                            <th data-column-id="createRoute">CRIAR ROTA</th>
                            <th data-column-id="settings">CONFIGURAÇÕES</th>
                            <th data-column-id="viewUsers">VISUALIZAR USUÁRIOS</th>
                            <th data-column-id="viewCompanies">VISUALIZAR EMPRESAS</th>
                            <th data-column-id="registerUsers">CADASTRAR USUÁRIOS</th>
                            <th data-column-id="registerCompanies">CADASTRAR EMPRESAS</th>
                            <th data-column-id="actions">AÇÕES</th>
                        </tr>
                    </thead>
                    <tbody id="permissionsTableBody">
                        <!-- Dados de permissões serão carregados aqui via JS -->
                    </tbody>
                </table>
            </div>
            <div class="permissions-pagination">
                <span>Mostrando 1 a <span id="displayedResultsCount"></span> de <span id="totalResultsCount"></span> resultados</span>
                <div class="permissions-pagination-buttons">
                    <button id="prevPageButton">&lt;</button>
                    <button class="active" id="currentPageButton">1</button>
                    <button id="nextPageButton">&gt;</button>
                </div>
            </div>

            <div class="permissions-panel-footer">
                <button class="back-button" onclick="window.location.href = 'dashboard.html'">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                    Voltar ao Dashboard
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Adicionar Nova Permissão -->
    <div id="addPermissionModal" class="add-permission-modal-overlay">
        <div class="add-permission-modal-content">
            <div class="add-permission-modal-header">
                <h3>Adicionar Nova Permissão</h3>
            </div>
            <label for="addPermissionAccessType">Tipo de Acesso</label>
            <input type="text" id="addPermissionAccessType" placeholder="Ex: Supervisor">

            <label for="addPermissionCompany">Empresa</label>
            <select id="addPermissionCompany">
                <option value="">Selecione uma empresa</option>
                <!-- As opções de empresa serão carregadas dinamicamente aqui via JS -->
            </select>

            <div class="checkbox-group">
                <label>
                    <input type="checkbox" id="addPermissionViewMap"> Visualizar Mapa
                </label>
                <label>
                    <input type="checkbox" id="addPermissionLocateTeam"> Localizar Equipe
                </label>
                <label>
                    <input type="checkbox" id="addPermissionViewHistory"> Visualizar Histórico
                </label>
                <label>
                    <input type="checkbox" id="addPermissionPrintHistory"> Imprimir Histórico
                </label>
                <label>
                    <input type="checkbox" id="addPermissionCreateRoute"> Criar Rota
                </label>
                <label>
                    <input type="checkbox" id="addPermissionSettings"> Configurações
                </label>
                <label>
                    <input type="checkbox" id="addPermissionViewUsers"> Visualizar Cadastros (usuários)
                </label>
                <label>
                    <input type="checkbox" id="addPermissionViewCompanies"> Visualizar Cadastros (empresas)
                </label>
                <label>
                    <input type="checkbox" id="addPermissionRegisterUsers"> Cadastrar (usuários)
                </label>
                <label>
                    <input type="checkbox" id="addPermissionRegisterCompanies"> Cadastrar (empresas)
                </label>
            </div>

            <div class="add-permission-modal-buttons">
                <button class="cancel-btn" onclick="closeAddPermissionModal()">Cancelar</button>
                <button class="save-btn" onclick="saveNewPermission()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- NOVO: Modal para Visualização/Edição de Permissão -->
    <div id="viewEditPermissionModal" class="view-edit-permission-modal-overlay">
        <div class="view-edit-permission-modal-content">
            <div class="view-edit-permission-modal-header">
                <h3 id="viewEditModalTitle">Detalhes da Permissão</h3>
            </div>
            <label for="viewEditPermissionAccessType">Tipo de Acesso</label>
            <input type="text" id="viewEditPermissionAccessType" placeholder="Ex: Supervisor">

            <label for="viewEditPermissionCompany">Empresa</label>
            <select id="viewEditPermissionCompany">
                <option value="">Selecione uma empresa</option>
                <!-- As opções de empresa serão carregadas dinamicamente aqui via JS -->
            </select>

            <div class="checkbox-group">
                <label>
                    <input type="checkbox" id="viewEditPermissionViewMap"> Visualizar Mapa
                </label>
                <label>
                    <input type="checkbox" id="viewEditPermissionLocateTeam"> Localizar Equipe
                </label>
                <label>
                    <input type="checkbox" id="viewEditPermissionViewHistory"> Visualizar Histórico
                </label>
                <label>
                    <input type="checkbox" id="viewEditPermissionPrintHistory"> Imprimir Histórico
                </label>
                <label>
                    <input type="checkbox" id="viewEditPermissionCreateRoute"> Criar Rota
                </label>
                <label>
                    <input type="checkbox" id="viewEditPermissionSettings"> Configurações
                </label>
                <label>
                    <input type="checkbox" id="viewEditPermissionViewUsers"> Visualizar Cadastros (usuários)
                </label>
                <label>
                    <input type="checkbox" id="viewEditPermissionViewCompanies"> Visualizar Cadastros (empresas)
                </label>
                <label>
                    <input type="checkbox" id="viewEditPermissionRegisterUsers"> Cadastrar (usuários)
                </label>
                <label>
                    <input type="checkbox" id="viewEditPermissionRegisterCompanies"> Cadastrar (empresas)
                </label>
            </div>

            <div class="view-edit-permission-modal-buttons">
                <button class="cancel-btn" onclick="closeViewEditPermissionModal()">Cancelar</button>
                <button class="update-btn" id="updatePermissionButton">Atualizar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Mensagens de Erro/Validação -->
    <div id="messageModal" class="message-modal-overlay">
        <div class="message-modal-content">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Atenção!</h3>
            <p id="modalMessageText" class="text-gray-700 mb-6">Mensagem de exemplo.</p>
            <div class="message-modal-buttons-group">
                <button id="modalCancelButton" class="cancel-button">Cancelar</button>
                <button id="modalOkButton" class="ok-button">OK</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        Carregando...
    </div>

    <script>
        // URL do seu Google Apps Script para o gerenciamento de permissões
        const APPS_SCRIPT_PERMISSIONS_URL = "https://script.google.com/macros/s/AKfycbxnotHPRqBWWgdJzKgrVC2tdSE5W65GUA5heoRRAK6JwNTsLTYnW7kT9WlKQYJx02zh/exec";

        // Variável para o temporizador de inatividade (copiado do dashboard)
        let inactivityTimer;
        const INACTIVITY_TIMEOUT = 30 * 60 * 1000; // 30 minutos

        // Dados de exemplo para as permissões (AGORA SERÃO CARREGADOS DA PLANILHA)
        let permissionsData = []; // Inicialmente vazio, será preenchido via fetch
        let companiesList = []; // Lista de empresas para o dropdown

        // Variáveis para paginação
        const rowsPerPage = 10; // Número de linhas por página
        let currentPage = 1;
        let filteredPermissions = []; // Dados filtrados para a paginação

        // Variáveis para armazenar a permissão atualmente em edição/visualização
        let currentEditingPermission = null;

        // Mapeamento de colunas para IDs e rótulos para o filtro de visibilidade
        const columnMap = [
            { id: 'company', label: 'Empresa', index: 0, essential: true },
            { id: 'accessType', label: 'Tipo de Acesso', index: 1, essential: true },
            { id: 'viewMap', label: 'Visualizar Mapa', index: 2, essential: false },
            { id: 'locateTeam', label: 'Localizar Equipe', index: 3, essential: false },
            { id: 'viewHistory', label: 'Histórico', index: 4, essential: false },
            { id: 'printHistory', label: 'Imprimir Histórico', index: 5, essential: false },
            { id: 'createRoute', label: 'Criar Rota', index: 6, essential: false },
            { id: 'settings', label: 'Configurações', index: 7, essential: false },
            { id: 'viewUsers', label: 'Visualizar Usuários', index: 8, essential: false },
            { id: 'viewCompanies', label: 'Visualizar Empresas', index: 9, essential: false },
            { id: 'registerUsers', label: 'Cadastrar Usuários', index: 10, essential: false },
            { id: 'registerCompanies', label: 'Cadastrar Empresas', index: 11, essential: false },
            { id: 'actions', label: 'Ações', index: 12, essential: true } // Ações é essencial
        ];

        // Estado de visibilidade das colunas (carregado do localStorage ou padrão)
        let columnVisibility = JSON.parse(localStorage.getItem('columnVisibility')) || {};
        // Inicializa com todas as colunas visíveis por padrão, se não houver no localStorage
        if (Object.keys(columnVisibility).length === 0) {
            columnMap.forEach(col => {
                columnVisibility[col.id] = true;
            });
            // Define 'Configurações' e 'Cadastrar Empresas' como desmarcadas inicialmente
            columnVisibility['settings'] = false;
            columnVisibility['registerCompanies'] = false;
            // Salva as preferências padrão no localStorage
            localStorage.setItem('columnVisibility', JSON.stringify(columnVisibility));
        }

        /**
         * Funções do Modal de Mensagens
         * @param {string} title - Título do modal.
         * @param {string} message - Mensagem do modal.
         * @param {function} okCallback - Função a ser executada quando o botão OK for clicado.
         * @param {boolean} showCancel - Se true, exibe o botão Cancelar.
         * @param {function} cancelCallback - Função a ser executada quando o botão Cancelar for clicado.
         */
        function showMessageModal(title, message, okCallback = null, showCancel = false, cancelCallback = null) {
            const modalOverlay = document.getElementById('messageModal');
            const modalTitle = modalOverlay.querySelector('h3');
            const modalMessageText = document.getElementById('modalMessageText');
            const modalOkButton = document.getElementById('modalOkButton');
            const modalCancelButton = document.getElementById('modalCancelButton');
            
            modalTitle.textContent = title;
            modalMessageText.textContent = message;

            // Limpa listeners anteriores para evitar múltiplos disparos
            modalOkButton.removeEventListener('click', handleOkClick);
            modalCancelButton.removeEventListener('click', handleCancelClick);

            // Adiciona novos listeners
            modalOkButton.addEventListener('click', handleOkClick);
            
            if (showCancel) {
                modalCancelButton.style.display = 'inline-block'; // Mostra o botão Cancelar
                modalCancelButton.addEventListener('click', handleCancelClick);
            } else {
                modalCancelButton.style.display = 'none'; // Esconde o botão Cancelar
            }

            modalOverlay.classList.add('show');

            function closeModal() {
                modalOverlay.classList.remove('show');
                // Remove os listeners após fechar para evitar vazamento de memória
                modalOkButton.removeEventListener('click', handleOkClick);
                modalCancelButton.removeEventListener('click', handleCancelClick);
            }

            function handleOkClick() {
                closeModal();
                if (okCallback) {
                    okCallback();
                }
            }

            function handleCancelClick() {
                closeModal();
                if (cancelCallback) {
                    cancelCallback();
                }
            }
        }

        /** Exibe ou oculta o overlay de carregamento */
        function toggleLoading(show) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (show) {
                loadingOverlay.classList.add('show');
            } else {
                loadingOverlay.classList.remove('show');
            }
        }

        /** Logout do usuário */
        function logout() {
            localStorage.removeItem('vigion_user_data');
            localStorage.removeItem('vigion_username');
            localStorage.removeItem('vigion_company'); 
            window.location.replace('index.html'); 
        }

        /**
         * Reinicia o temporizador de inatividade.
         * Chama logout() se o tempo limite for atingido.
         */
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                console.log("Usuário inativo por mais de 30 minutos. Deslogando...");
                showMessageModal("Sessão Expirada", "Você foi desconectado devido à inatividade.", () => {
                    logout();
                });
            }, INACTIVITY_TIMEOUT);
        }

        /**
         * Busca os dados de permissões da planilha via Google Apps Script.
         */
        async function fetchPermissions() {
            toggleLoading(true); // Mostra o loading
            try {
                const response = await fetch(APPS_SCRIPT_PERMISSIONS_URL);
                const result = await response.json();

                if (result.status === "sucesso") {
                    permissionsData = result.data;
                    filteredPermissions = permissionsData; // Inicializa dados filtrados
                    renderPermissionsTable(filteredPermissions);
                } else {
                    showMessageModal("Erro ao Carregar", result.message || "Não foi possível carregar as permissões da planilha.");
                    permissionsData = []; // Limpa os dados se houver erro
                    filteredPermissions = [];
                    renderPermissionsTable([]); // Renderiza tabela vazia
                }
            } catch (error) {
                console.error("Erro na requisição fetchPermissions:", error);
                showMessageModal("Erro de Conexão", "Não foi possível conectar ao servidor para carregar as permissões.");
                permissionsData = [];
                filteredPermissions = [];
                renderPermissionsTable([]);
            } finally {
                toggleLoading(false); // Esconde o loading
            }
        }

        /**
         * Busca a lista de empresas da API Centralizada do Google Apps Script
         * e preenche o dropdown do modal de adição de permissão.
         */
        async function fetchCompanies() {
            toggleLoading(true); // Mostra o loading
            try {
                const params = new URLSearchParams({
                    action: 'getCompanies' // Ação para buscar empresas
                });
                // CHAMA O MESMO SCRIPT DE PERMISSÕES, AGORA COM AÇÃO 'getCompanies'
                const response = await fetch(`${APPS_SCRIPT_PERMISSIONS_URL}?${params.toString()}`);
                const result = await response.json();

                if (result.status === "sucesso") {
                    companiesList = result.data;
                    populateCompanyDropdown(companiesList, 'addPermissionCompany'); // Para o modal de Adicionar
                    populateCompanyDropdown(companiesList, 'viewEditPermissionCompany'); // Para o modal de Visualizar/Editar
                } else {
                    showMessageModal("Erro ao Carregar Empresas", result.message || "Não foi possível carregar a lista de empresas.");
                    companiesList = [];
                }
            } catch (error) {
                console.error("Erro na requisição fetchCompanies:", error);
                showMessageModal("Erro de Conexão", "Não foi possível conectar ao servidor para carregar as empresas.");
                companiesList = [];
            } finally {
                toggleLoading(false); // Esconde o loading
            }
        }

        /**
         * Preenche o dropdown de empresas em um elemento select específico.
         * @param {Array} companies - Lista de objetos de empresa (ex: [{ nome: "Empresa A", ... }]).
         * @param {string} selectId - O ID do elemento <select> a ser preenchido.
         */
        function populateCompanyDropdown(companies, selectId) {
            const selectElement = document.getElementById(selectId);
            if (!selectElement) return; // Sai se o elemento não for encontrado

            selectElement.innerHTML = '<option value="">Selecione uma empresa</option>'; // Limpa e adiciona a opção padrão

            companies.forEach(company => {
                const option = document.createElement('option');
                option.value = company.nome; // Usa o nome da empresa como valor
                option.textContent = company.nome; // Exibe o nome da empresa
                selectElement.appendChild(option);
            });
        }


        // Função para renderizar a tabela de permissões com paginação
        function renderPermissionsTable(data) {
            const tableBody = document.getElementById('permissionsTableBody');
            tableBody.innerHTML = ''; // Limpa o corpo da tabela

            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            const paginatedData = data.slice(startIndex, endIndex);

            paginatedData.forEach(permission => {
                const row = tableBody.insertRow();
                // Adiciona um data-column-id para cada célula para fácil manipulação da visibilidade
                row.innerHTML = `
                    <td data-column-id="company">${permission.company}</td>
                    <td data-column-id="accessType">${permission.accessType}</td>
                    <td data-column-id="viewMap" class="checkbox-cell">
                        <label>
                            <input type="checkbox" class="permission-checkbox" ${permission.viewMap ? 'checked' : ''} disabled>
                            <span>${permission.viewMap ? 'SIM' : 'NÃO'}</span>
                        </label>
                    </td>
                    <td data-column-id="locateTeam" class="checkbox-cell">
                        <label>
                            <input type="checkbox" class="permission-checkbox" ${permission.locateTeam ? 'checked' : ''} disabled>
                            <span>${permission.locateTeam ? 'SIM' : 'NÃO'}</span>
                        </label>
                    </td>
                    <td data-column-id="viewHistory" class="checkbox-cell">
                        <label>
                            <input type="checkbox" class="permission-checkbox" ${permission.viewHistory ? 'checked' : ''} disabled>
                            <span>${permission.viewHistory ? 'SIM' : 'NÃO'}</span>
                        </label>
                    </td>
                    <td data-column-id="printHistory" class="checkbox-cell">
                        <label>
                            <input type="checkbox" class="permission-checkbox" ${permission.printHistory ? 'checked' : ''} disabled>
                            <span>${permission.printHistory ? 'SIM' : 'NÃO'}</span>
                        </label>
                    </td>
                    <td data-column-id="createRoute" class="checkbox-cell">
                        <label>
                            <input type="checkbox" class="permission-checkbox" ${permission.createRoute ? 'checked' : ''} disabled>
                            <span>${permission.createRoute ? 'SIM' : 'NÃO'}</span>
                        </label>
                    </td>
                    <td data-column-id="settings" class="checkbox-cell">
                        <label>
                            <input type="checkbox" class="permission-checkbox" ${permission.settings ? 'checked' : ''} disabled>
                            <span>${permission.settings ? 'SIM' : 'NÃO'}</span>
                        </label>
                    </td>
                    <td data-column-id="viewUsers" class="checkbox-cell">
                        <label>
                            <input type="checkbox" class="permission-checkbox" ${permission.viewUsers ? 'checked' : ''} disabled>
                            <span>${permission.viewUsers ? 'SIM' : 'NÃO'}</span>
                        </label>
                    </td>
                    <td data-column-id="viewCompanies" class="checkbox-cell">
                        <label>
                            <input type="checkbox" class="permission-checkbox" ${permission.viewCompanies ? 'checked' : ''} disabled>
                            <span>${permission.viewCompanies ? 'SIM' : 'NÃO'}</span>
                        </label>
                    </td>
                    <td data-column-id="registerUsers" class="checkbox-cell">
                        <label>
                            <input type="checkbox" class="permission-checkbox" ${permission.registerUsers ? 'checked' : ''} disabled>
                            <span>${permission.registerUsers ? 'SIM' : 'NÃO'}</span>
                        </label>
                    </td>
                    <td data-column-id="registerCompanies" class="checkbox-cell">
                        <label>
                            <input type="checkbox" class="permission-checkbox" ${permission.registerCompanies ? 'checked' : ''} disabled>
                            <span>${permission.registerCompanies ? 'SIM' : 'NÃO'}</span>
                        </label>
                    </td>
                    <td class="action-buttons" data-column-id="actions">
                        <button title="Visualizar Permissões" onclick="viewPermission('${permission.accessType}', '${permission.company}')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                        </button>
                        <button title="Editar Permissões" onclick="editPermission('${permission.accessType}', '${permission.company}')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.85 0 0 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="M15 5l4 4"/></svg>
                        </button>
                        <button title="Excluir Permissão" onclick="deletePermission('${permission.accessType}', '${permission.company}')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        </button>
                    </td>
                `;
            });
            applyColumnVisibility(); // Aplica a visibilidade após renderizar a tabela
            updatePagination(data.length);
        }

        // Lógica de filtragem da tabela de permissões (simulada)
        document.getElementById('searchPermissionInput').addEventListener('input', (event) => {
            const searchTerm = event.target.value.toLowerCase();
            filteredPermissions = permissionsData.filter(p => 
                p.accessType.toLowerCase().includes(searchTerm) ||
                p.company.toLowerCase().includes(searchTerm)
            );
            currentPage = 1; // Reseta para a primeira página ao filtrar
            renderPermissionsTable(filteredPermissions);
        });

        // Função para abrir o modal de adição de permissão
        document.getElementById('addPermissionButton').addEventListener('click', () => {
            openAddPermissionModal();
        });

        function openAddPermissionModal() {
            resetInactivityTimer();
            document.getElementById('addPermissionModal').classList.add('show');
            // Limpa os campos e define valores padrão
            document.getElementById('addPermissionAccessType').value = '';
            document.getElementById('addPermissionCompany').value = ''; // Define vazio para "Selecione uma empresa"
            document.getElementById('addPermissionViewMap').checked = false;
            document.getElementById('addPermissionLocateTeam').checked = false;
            document.getElementById('addPermissionViewHistory').checked = false;
            document.getElementById('addPermissionPrintHistory').checked = false;
            document.getElementById('addPermissionCreateRoute').checked = false;
            document.getElementById('addPermissionSettings').checked = false;
            document.getElementById('addPermissionViewUsers').checked = false;
            document.getElementById('addPermissionViewCompanies').checked = false;
            document.getElementById('addPermissionRegisterUsers').checked = false;
            document.getElementById('addPermissionRegisterCompanies').checked = false;
        }

        function closeAddPermissionModal() {
            document.getElementById('addPermissionModal').classList.remove('show');
            resetInactivityTimer();
        }

        /**
         * Salva uma nova permissão ou atualiza uma existente na planilha via Apps Script.
         */
        async function saveNewPermission() {
            const accessType = document.getElementById('addPermissionAccessType').value.trim();
            const company = document.getElementById('addPermissionCompany').value;
            const viewMap = document.getElementById('addPermissionViewMap').checked;
            const locateTeam = document.getElementById('addPermissionLocateTeam').checked;
            const viewHistory = document.getElementById('addPermissionViewHistory').checked;
            const printHistory = document.getElementById('addPermissionPrintHistory').checked;
            const createRoute = document.getElementById('addPermissionCreateRoute').checked;
            const settings = document.getElementById('addPermissionSettings').checked;
            const viewUsers = document.getElementById('addPermissionViewUsers').checked;
            const viewCompanies = document.getElementById('addPermissionViewCompanies').checked;
            const registerUsers = document.getElementById('addPermissionRegisterUsers').checked;
            const registerCompanies = document.getElementById('addPermissionRegisterCompanies').checked;

            if (!accessType || !company) {
                showMessageModal("Atenção", "Por favor, preencha o 'Tipo de Acesso' e selecione uma 'Empresa'.");
                return;
            }

            toggleLoading(true); // Mostra o loading

            try {
                const params = new URLSearchParams({
                    action: 'save', // Ação para o Apps Script
                    company: company,
                    accessType: accessType,
                    viewMap: viewMap,
                    locateTeam: locateTeam,
                    viewHistory: viewHistory,
                    printHistory: printHistory,
                    createRoute: createRoute,
                    settings: settings,
                    viewUsers: viewUsers,
                    viewCompanies: viewCompanies,
                    registerUsers: registerUsers,
                    registerCompanies: registerCompanies
                });

                const response = await fetch(`${APPS_SCRIPT_PERMISSIONS_URL}?${params.toString()}`);
                const result = await response.json();

                if (result.status === "sucesso") {
                    showMessageModal("Sucesso", result.message, () => {
                        closeAddPermissionModal();
                        fetchPermissions(); // Recarrega os dados da tabela
                    });
                } else {
                    showMessageModal("Erro", result.message || "Ocorreu um erro ao salvar a permissão.");
                }
            } catch (error) {
                console.error("Erro ao salvar permissão:", error);
                showMessageModal("Erro de Conexão", "Não foi possível conectar ao servidor para salvar a permissão.");
            } finally {
                toggleLoading(false); // Esconde o loading
            }
        }

        /**
         * Abre o modal de visualização de permissão.
         * @param {string} accessType - O tipo de acesso da permissão.
         * @param {string} company - A empresa associada à permissão.
         */
        function viewPermission(accessType, company) {
            resetInactivityTimer();
            const permission = permissionsData.find(p => p.accessType === accessType && p.company === company);
            if (permission) {
                currentEditingPermission = permission; // Armazena a permissão para referência
                populateViewEditPermissionModal(permission, false); // false para modo de visualização
                document.getElementById('viewEditModalTitle').textContent = 'Detalhes da Permissão';
                document.getElementById('updatePermissionButton').style.display = 'none'; // Esconde o botão de Atualizar
                document.getElementById('viewEditPermissionModal').classList.add('show');
            } else {
                showMessageModal("Erro", "Permissão não encontrada para visualização.");
            }
        }

        /**
         * Abre o modal de edição de permissão.
         * @param {string} accessType - O tipo de acesso da permissão.
         * @param {string} company - A empresa associada à permissão.
         */
        function editPermission(accessType, company) {
            resetInactivityTimer();
            const permission = permissionsData.find(p => p.accessType === accessType && p.company === company);
            if (permission) {
                currentEditingPermission = permission; // Armazena a permissão para referência
                populateViewEditPermissionModal(permission, true); // true para modo de edição
                document.getElementById('viewEditModalTitle').textContent = 'Editar Permissão';
                document.getElementById('updatePermissionButton').style.display = 'inline-block'; // Mostra o botão de Atualizar
                document.getElementById('viewEditPermissionModal').classList.add('show');
            } else {
                showMessageModal("Erro", "Permissão não encontrada para edição.");
            }
        }

        /**
         * Preenche o modal de visualização/edição com os dados da permissão.
         * @param {object} permission - O objeto de permissão.
         * @param {boolean} isEditMode - True se for modo de edição, false para visualização.
         */
        function populateViewEditPermissionModal(permission, isEditMode) {
            document.getElementById('viewEditPermissionAccessType').value = permission.accessType;
            document.getElementById('viewEditPermissionCompany').value = permission.company;
            document.getElementById('viewEditPermissionViewMap').checked = permission.viewMap;
            document.getElementById('viewEditPermissionLocateTeam').checked = permission.locateTeam;
            document.getElementById('viewEditPermissionViewHistory').checked = permission.viewHistory;
            document.getElementById('viewEditPermissionPrintHistory').checked = permission.printHistory;
            document.getElementById('viewEditPermissionCreateRoute').checked = permission.createRoute;
            document.getElementById('viewEditPermissionSettings').checked = permission.settings;
            document.getElementById('viewEditPermissionViewUsers').checked = permission.viewUsers;
            document.getElementById('viewEditPermissionViewCompanies').checked = permission.viewCompanies;
            document.getElementById('viewEditPermissionRegisterUsers').checked = permission.registerUsers;
            document.getElementById('viewEditPermissionRegisterCompanies').checked = permission.registerCompanies;

            // Define o estado de disabled para todos os campos
            const inputs = document.querySelectorAll('#viewEditPermissionModal input[type="text"], #viewEditPermissionModal select, #viewEditPermissionModal input[type="checkbox"]');
            inputs.forEach(input => {
                input.disabled = !isEditMode;
            });

            // Campos de empresa e tipo de acesso AGORA PODEM SER EDITADOS
            // Mas eles precisam ser passados como originais para o Apps Script
            document.getElementById('viewEditPermissionAccessType').disabled = !isEditMode;
            document.getElementById('viewEditPermissionCompany').disabled = !isEditMode;
        }

        /** Fecha o modal de visualização/edição de permissão. */
        function closeViewEditPermissionModal() {
            document.getElementById('viewEditPermissionModal').classList.remove('show');
            resetInactivityTimer();
            currentEditingPermission = null; // Limpa a permissão em edição
        }

        /**
         * Atualiza uma permissão existente na planilha via Apps Script.
         */
        document.getElementById('updatePermissionButton').addEventListener('click', async () => {
            if (!currentEditingPermission) {
                showMessageModal("Erro", "Nenhuma permissão selecionada para atualização.");
                return;
            }

            // Coleta os valores ATUAIS do modal (que podem ter sido editados)
            const newAccessType = document.getElementById('viewEditPermissionAccessType').value.trim();
            const newCompany = document.getElementById('viewEditPermissionCompany').value;
            const viewMap = document.getElementById('viewEditPermissionViewMap').checked;
            const locateTeam = document.getElementById('viewEditPermissionLocateTeam').checked;
            const viewHistory = document.getElementById('viewEditPermissionViewHistory').checked;
            const printHistory = document.getElementById('viewEditPermissionPrintHistory').checked;
            const createRoute = document.getElementById('viewEditPermissionCreateRoute').checked;
            const settings = document.getElementById('viewEditPermissionSettings').checked;
            const viewUsers = document.getElementById('viewEditPermissionViewUsers').checked;
            const viewCompanies = document.getElementById('viewEditPermissionViewCompanies').checked;
            const registerUsers = document.getElementById('viewEditPermissionRegisterUsers').checked;
            const registerCompanies = document.getElementById('viewEditPermissionRegisterCompanies').checked;

            // Valores ORIGINAIS da permissão antes da edição
            const originalAccessType = currentEditingPermission.accessType;
            const originalCompany = currentEditingPermission.company;

            if (!newAccessType || !newCompany) {
                showMessageModal("Atenção", "Por favor, preencha o 'Tipo de Acesso' e selecione uma 'Empresa'.");
                return;
            }

            toggleLoading(true); // Mostra o loading

            try {
                const params = new URLSearchParams({
                    action: 'save', // Reutiliza a ação 'save' que já lida com atualização
                    // Passa os valores ORIGINAIS para identificar a linha na planilha
                    originalCompany: originalCompany,
                    originalAccessType: originalAccessType,
                    // Passa os NOVOS valores para atualizar a linha
                    company: newCompany,
                    accessType: newAccessType,
                    viewMap: viewMap,
                    locateTeam: locateTeam,
                    viewHistory: viewHistory,
                    printHistory: printHistory,
                    createRoute: createRoute,
                    settings: settings,
                    viewUsers: viewUsers,
                    viewCompanies: viewCompanies,
                    registerUsers: registerUsers,
                    registerCompanies: registerCompanies
                });

                const response = await fetch(`${APPS_SCRIPT_PERMISSIONS_URL}?${params.toString()}`);
                const result = await response.json();

                if (result.status === "sucesso") {
                    showMessageModal("Sucesso", result.message, () => {
                        closeViewEditPermissionModal();
                        fetchPermissions(); // Recarrega os dados da tabela
                    });
                } else {
                    showMessageModal("Erro", result.message || "Ocorreu um erro ao atualizar a permissão.");
                }
            } catch (error) {
                console.error("Erro ao atualizar permissão:", error);
                showMessageModal("Erro de Conexão", "Não foi possível conectar ao servidor para atualizar a permissão.");
            } finally {
                toggleLoading(false); // Esconde o loading
            }
        });


        /**
         * Exclui uma permissão da planilha via Apps Script após confirmação.
         * @param {string} accessType - O tipo de acesso da permissão a ser excluída.
         * @param {string} company - A empresa associada à permissão a ser excluída.
         */
        function deletePermission(accessType, company) {
            showMessageModal(
                "Confirmação",
                `Tem certeza que deseja excluir a permissão para "${accessType}" da empresa "${company}"?`,
                async () => { // okCallback
                    toggleLoading(true); // Mostra o loading
                    try {
                        const params = new URLSearchParams({
                            action: 'delete', // Ação para o Apps Script
                            company: company,
                            accessType: accessType
                        });

                        const response = await fetch(`${APPS_SCRIPT_PERMISSIONS_URL}?${params.toString()}`);
                        const result = await response.json();

                        if (result.status === "sucesso") {
                            showMessageModal("Sucesso", result.message, () => {
                                currentPage = 1; // Volta para a primeira página após exclusão
                                fetchPermissions(); // Recarrega os dados da tabela
                            });
                        } else {
                            showMessageModal("Erro", result.message || "Ocorreu um erro ao excluir a permissão.");
                        }
                    } catch (error) {
                        console.error("Erro ao excluir permissão:", error);
                        showMessageModal("Erro de Conexão", "Não foi possível conectar ao servidor para excluir a permissão.");
                    } finally {
                        toggleLoading(false); // Esconde o loading
                    }
                },
                true, // showCancel = true
                () => { // cancelCallback
                    console.log("Exclusão cancelada pelo usuário.");
                    // Nenhuma ação adicional é necessária, o modal já foi fechado.
                }
            );
        }

        // Funções de paginação
        function updatePagination(totalRows) {
            const totalPages = Math.ceil(totalRows / rowsPerPage);
            document.getElementById('currentPageButton').textContent = currentPage;
            document.getElementById('prevPageButton').disabled = (currentPage === 1);
            document.getElementById('nextPageButton').disabled = (currentPage === totalPages || totalPages === 0);

            const startIndex = (currentPage - 1) * rowsPerPage;
            const displayedCount = Math.min(currentPage * rowsPerPage, totalRows);
            document.getElementById('displayedResultsCount').textContent = displayedCount;
            document.getElementById('totalResultsCount').textContent = totalRows;
        }

        document.getElementById('prevPageButton').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderPermissionsTable(filteredPermissions);
            }
        });

        document.getElementById('nextPageButton').addEventListener('click', () => {
            const totalPages = Math.ceil(filteredPermissions.length / rowsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderPermissionsTable(filteredPermissions);
            }
        });

        // --- Funções de Visibilidade de Colunas (para o novo popover) ---
        function generateColumnCheckboxes() {
            const container = document.getElementById('columnVisibilityCheckboxes');
            container.innerHTML = ''; // Limpa o container

            columnMap.forEach(col => {
                if (!col.essential) { // Apenas colunas não essenciais podem ser ocultadas
                    const label = document.createElement('label');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `toggle-${col.id}`;
                    checkbox.checked = columnVisibility[col.id]; // Define o estado inicial

                    checkbox.addEventListener('change', (event) => {
                        toggleColumnVisibility(col.id, event.target.checked);
                    });

                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode(col.label));
                    container.appendChild(label);
                }
            });
            updateCheckboxStates(); // Atualiza o estado dos checkboxes (habilitado/desabilitado)
        }

        function toggleColumnVisibility(columnId, isVisible) {
            // Conta quantas colunas estão ocultas *antes* da mudança atual
            const currentlyHidden = Object.values(columnVisibility).filter(v => !v).length;
            const maxHidden = 3; // Limite de colunas que podem ser ocultadas

            if (!isVisible && currentlyHidden >= maxHidden) {
                // Se o usuário tentar ocultar mais de 3 colunas, reverte o checkbox e avisa
                showMessageModal("Atenção", `Você pode ocultar no máximo ${maxHidden} colunas. Desmarque uma coluna oculta para ocultar outra.`);
                // Não é necessário reverter o checkbox aqui, pois ele já não foi alterado no evento 'change'
                // O estado do checkbox no DOM já reflete o estado ANTERIOR ao clique que causou a tentativa de ocultar.
                // A função updateCheckboxStates() será chamada em seguida e irá corrigir o estado visual.
                return; // Impede a alteração do estado da coluna
            }

            columnVisibility[columnId] = isVisible; // Atualiza o estado
            localStorage.setItem('columnVisibility', JSON.stringify(columnVisibility)); // Salva no localStorage
            applyColumnVisibility(); // Aplica a visibilidade na tabela
            updateCheckboxStates(); // Atualiza o estado dos checkboxes (habilitado/desabilitado)
        }

        function applyColumnVisibility() {
            columnMap.forEach(col => {
                const isVisible = columnVisibility[col.id];
                // Seleciona todos os cabeçalhos e células de dados para esta coluna
                const headers = document.querySelectorAll(`th[data-column-id="${col.id}"]`);
                const cells = document.querySelectorAll(`td[data-column-id="${col.id}"]`);

                headers.forEach(th => {
                    th.style.display = isVisible ? '' : 'none';
                });
                cells.forEach(td => {
                    td.style.display = isVisible ? '' : 'none';
                });
            });
        }

        function updateCheckboxStates() {
            const currentlyHidden = Object.values(columnVisibility).filter(v => !v).length;
            const maxHidden = 3;

            columnMap.forEach(col => {
                if (!col.essential) {
                    const checkbox = document.getElementById(`toggle-${col.id}`);
                    if (checkbox) {
                        // Se a coluna está visível E o limite de ocultas foi atingido, desabilita para impedir ocultar mais.
                        // Se a coluna está oculta, ela DEVE permanecer habilitada para poder ser reexibida.
                        if (columnVisibility[col.id] === true && currentlyHidden >= maxHidden) {
                            checkbox.disabled = true;
                        } else {
                            checkbox.disabled = false;
                        }
                    }
                }
            });
        }

        // Funções para abrir/fechar o popover de filtro
        function toggleColumnFilterPopover() {
            const popover = document.getElementById('columnFilterPopover');
            popover.classList.toggle('show');
            // Adiciona um listener para fechar o popover se clicar fora dele
            if (popover.classList.contains('show')) {
                document.addEventListener('click', closeColumnFilterPopoverOutside);
            } else {
                document.removeEventListener('click', closeColumnFilterPopoverOutside);
            }
        }

        function closeColumnFilterPopoverOutside(event) {
            const popover = document.getElementById('columnFilterPopover');
            const button = document.getElementById('toggleColumnFilterButton');
            // Se o clique não foi no popover nem no botão que o abre, fecha o popover
            if (!popover.contains(event.target) && !button.contains(event.target)) {
                popover.classList.remove('show');
                document.removeEventListener('click', closeColumnFilterPopoverOutside);
            }
        }

        // Inicialização ao carregar a página
        window.addEventListener('load', () => {
            fetchPermissions(); // Carrega os dados de permissões da planilha ao iniciar
            fetchCompanies(); // Carrega a lista de empresas para o dropdown
            generateColumnCheckboxes(); // Gera os checkboxes de visibilidade de colunas
            applyColumnVisibility(); // Aplica a visibilidade inicial das colunas

            // Adiciona listener para o botão de filtro de colunas
            document.getElementById('toggleColumnFilterButton').addEventListener('click', (event) => {
                event.stopPropagation(); // Impede que o clique se propague e feche o popover imediatamente
                toggleColumnFilterPopover();
            });

            // Inicia o temporizador de inatividade
            resetInactivityTimer();

            // Adiciona event listeners para reiniciar o temporizador em qualquer interação
            document.addEventListener('mousemove', resetInactivityTimer);
            document.addEventListener('keypress', resetInactivityTimer);
            document.addEventListener('click', resetInactivityTimer);
            document.addEventListener('scroll', resetInactivityTimer);
            document.addEventListener('touchstart', resetInactivityTimer);
            document.addEventListener('touchmove', resetInactivityTimer);
        });
    </script>
</body>
</html>
