<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Cadastros VigiOn</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome para ícones de ações -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            color: #374151; /* Dark gray text */
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        table {
            width: 100%; /* Garante que a tabela ocupe a largura total do seu contêiner */
            border-collapse: collapse;
            margin-top: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 0.5rem;
            overflow: hidden; /* Ensures rounded corners are applied to table content */
            table-layout: auto; /* Permite que as colunas se ajustem ao conteúdo */
        }
        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb; /* Light gray border */
            /* Adicionado para ajudar no redimensionamento de colunas */
            white-space: normal; /* Permite que o texto quebre linha */
            word-break: break-word; /* Força a quebra de palavras longas */
        }
        th {
            background-color: #F7FAFC; /* Light background for table header */
            color: #374151; /* Dark text for contrast */
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }
        tr:nth-child(even) {
            background-color: #f9fafb; /* Lighter gray for even rows */
        }
        tr:hover {
            background-color: #e0e7ff; /* Light blue on hover */
            transition: background-color 0.2s ease-in-out;
        }
        .message-box {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            font-weight: 500;
        }
        .message-box.loading {
            background-color: #bfdbfe; /* Blue 200 */
            color: #1e40af; /* Blue 800 */
            border: 1px solid #93c5fd; /* Blue 300 */
        }
        .message-box.error {
            background-color: #fecaca; /* Red 200 */
            color: #b91c1c; /* Red 800 */
            border: 1px solid #fca5a5; /* Red 300 */
        }
        .message-box.success { /* Novo estilo para mensagens de sucesso */
            background-color: #d1fae5; /* Green 100 */
            color: #065f46; /* Green 800 */
            border: 1px solid #a7f3d0; /* Green 200 */
        }
        /* Estilos para as abas */
        .tab-buttons {
            display: flex;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e5e7eb;
        }
        .tab-button {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            font-weight: 600;
            color: #6b7280; /* Gray 500 */
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease-in-out;
        }
        .tab-button.active {
            color: #4f46e5; /* Indigo 600 */
            border-color: #4f46e5;
        }
        .header-bar {
            background-color: #5A73D4; /* Alterado para o novo tom de azul */
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.5rem 0.5rem 0 0; /* Rounded top corners */
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .header-bar h1 {
            font-size: 1.75rem; /* text-2xl */
            font-weight: 700; /* font-bold */
        }
        .add-button {
            background-color: #6200EE; /* Deep Purple */
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 9999px; /* Full rounded */
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background-color 0.2s ease-in-out;
        }
        .add-button:hover {
            background-color: #5200D1; /* Slightly darker purple on hover */
        }
        .filter-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background-color: #f9fafb;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            flex-wrap: wrap; /* Permite que os itens quebrem para a próxima linha em telas pequenas */
            gap: 1rem; /* Espaçamento entre os itens do filtro */
        }
        .filter-section input,
        .filter-section select {
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            color: #374151;
            background-color: white;
            flex-grow: 1; /* Permite que os inputs e selects cresçam */
            min-width: 150px; /* Largura mínima para inputs */
        }
        .filter-section select {
            max-width: 150px; /* Largura máxima para o select de status */
        }
        .filter-section input:focus,
        .filter-section select:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .action-buttons {
            white-space: nowrap; /* Garante que os botões não quebrem linha */
        }
        .action-buttons button {
            background: none;
            border: none;
            cursor: pointer;
            color: #6b7280;
            margin-right: 0.75rem; /* Aumenta o espaçamento entre os ícones */
            font-size: 0.95rem; /* Reduz ligeiramente o tamanho dos ícones */
            transition: color 0.2s ease-in-out;
        }
        .action-buttons button:last-child {
            margin-right: 0; /* Remove margem do último botão */
        }
        .action-buttons button:hover {
            color: #4f46e5;
        }
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 1.5rem;
            gap: 0.5rem;
        }
        .pagination button {
            background-color: #e5e7eb;
            color: #4b5563;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .pagination button:hover:not(.active):not(:disabled) { /* Adicionado :not(:disabled) */
            background-color: #d1d5db;
        }
        .pagination button.active {
            background-color: #4f46e5;
            color: white;
        }
        .pagination button:disabled { /* Estilo para botões desabilitados */
            opacity: 0.6;
            cursor: not-allowed;
        }
        .pagination-info {
            font-size: 0.875rem;
            color: #6b7280;
        }
        .back-button {
            background-color: #ef4444; /* Red 500 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background-color 0.2s ease-in-out;
            margin-top: 2rem;
            float: right; /* Alinha à direita */
        }
        .back-button:hover {
            background-color: #dc2626; /* Red 600 */
        }

        /* Estilos do Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5); /* Fundo semi-transparente escuro */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000; /* Garante que o modal fique acima de outros elementos */
            opacity: 0; /* Inicialmente invisível */
            visibility: hidden; /* Esconde completamente para não interferir com eventos de clique */
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 500px; /* Largura máxima para o modal */
            transform: translateY(-20px); /* Começa um pouco acima */
            transition: transform 0.3s ease-in-out;
        }
        .modal-overlay.active .modal-content {
            transform: translateY(0); /* Desliza para a posição final */
        }
        /* Estilo para a mensagem de erro/sucesso dentro do modal */
        #modalMessage { /* Alterado para uma ID genérica para mensagens */
            padding: 0.75rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }
        #modalMessage.error {
            background-color: #fecaca; /* Red 200 */
            color: #b91c1c; /* Red 800 */
            border: 1px solid #fca5a5; /* Red 300 */
        }
        #modalMessage.success {
            background-color: #d1fae5; /* Green 100 */
            color: #065f46; /* Green 800 */
            border: 1px solid #a7f3d0; /* Green 200 */
        }
    </style>
</head>
<body class="antialiased">
    <!-- Conteúdo Principal do Painel -->
    <div id="mainContent" class="container">
        <header class="header-bar">
            <h1>Painel de Cadastros</h1>
            <div class="flex items-center gap-4">
                <span id="currentUserInfo" class="text-sm font-medium"></span>
                <button id="addUsuarioButton" class="add-button">
                    <i class="fas fa-plus"></i> Adicionar
                </button>
            </div>
        </header>

        <div class="bg-white p-6 rounded-b-lg shadow-md mb-8">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="showTab('usuarios')">Usuários</button>
                <button class="tab-button" onclick="showTab('empresas')">Empresas</button>
            </div>

            <div id="usuariosTab" class="tab-content active">
                <div class="filter-section">
                    <input type="text" id="searchUserInput" placeholder="Pesquisar por nome...">
                    <div class="flex items-center gap-2">
                        <span>Autenticado:</span>
                        <select id="statusUserFilter">
                            <option value="Todos">Todos</option>
                            <option value="SIM">SIM</option>
                            <option value="NÃO">NÃO</option>
                        </select>
                    </div>
                </div>
                <div id="loadingUsuarios" class="message-box loading">
                    Carregando dados de usuários...
                </div>
                <div id="errorUsuarios" class="message-box error hidden">
                    Erro ao carregar dados de usuários.
                </div>
                <!-- Removida a classe overflow-x-auto do contêiner da tabela de usuários -->
                <div id="usuariosTableContainer">
                    <table id="usuariosTable" class="min-w-full">
                        <thead>
                            <tr>
                                <th>USUÁRIO</th>
                                <th>NOME</th>
                                <th>EMPRESA</th>
                                <th>ACESSO</th>
                                <th>AUTENTICADO</th>
                                <th>AÇÕES</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dados dos usuários serão inseridos aqui pelo JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div id="usuariosPagination" class="pagination">
                    <span id="usuariosPaginationInfo" class="pagination-info"></span>
                    <button onclick="goToPage('usuarios', currentPageUsuarios - 1)">&lt;</button>
                    <div id="usuariosPageNumbers" class="flex gap-2">
                        <!-- Números das páginas serão inseridos aqui -->
                    </div>
                    <button onclick="goToPage('usuarios', currentPageUsuarios + 1)">&gt;</button>
                </div>
            </div>

            <div id="empresasTab" class="tab-content">
                <div class="filter-section">
                    <input type="text" id="searchCompanyInput" placeholder="Pesquisar por nome...">
                    <div class="flex items-center gap-2">
                        <span>Status:</span>
                        <select id="statusCompanyFilter">
                            <option value="Todos">Todos</option>
                            <option value="Ativos">Ativos</option>
                            <option value="Inativos">Inativos</option>
                        </select>
                    </div>
                </div>

                <div id="loadingEmpresas" class="message-box loading">
                    Carregando dados de empresas...
                </div>
                <div id="errorEmpresas" class="message-box error hidden">
                    Erro ao carregar dados de empresas.
                </div>
                <!-- Removida a classe overflow-x-auto do contêiner da tabela de empresas -->
                <div id="empresasTableContainer">
                    <table id="empresasTable" class="min-w-full">
                        <thead>
                            <tr>
                                <th>CNPJ</th>
                                <th>NOME</th>
                                <th>PROPRIETARIO</th>
                                <th>STATUS</th>
                                <th>AÇÕES</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dados das empresas serão inseridos aqui pelo JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div id="empresasPagination" class="pagination">
                    <span id="empresasPaginationInfo" class="pagination-info"></span>
                    <button onclick="goToPage('empresas', currentPageEmpresas - 1)">&lt;</button>
                    <div id="empresasPageNumbers" class="flex gap-2">
                        <!-- Números das páginas serão inseridos aqui -->
                    </div>
                    <button onclick="goToPage('empresas', currentPageEmpresas + 1)">&gt;</button>
                </div>
            </div>
            <button id="backButton" class="back-button">
                <i class="fas fa-arrow-left"></i> Volrar
            </button>
        </div>
    </div>

    <!-- Modal para Cadastrar Usuário -->
    <div id="userModal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Cadastrar Usuário</h2>

            <!-- Mensagem de erro/sucesso dentro do modal -->
            <div id="modalMessage" class="message-box hidden"></div>

            <form id="userForm">
                <div class="mb-4">
                    <label for="modalUsuario" class="block text-sm font-medium text-gray-700 mb-1">USUÁRIO</label>
                    <input type="text" id="modalUsuario" name="usuario" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div class="mb-4">
                    <label for="modalNome" class="block text-sm font-medium text-gray-700 mb-1">NOME</label>
                    <input type="text" id="modalNome" name="nome" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div class="mb-4">
                    <label for="modalEmpresa" class="block text-sm font-medium text-gray-700 mb-1">EMPRESA</label>
                    <!-- Agora apenas um select para empresa, sempre ativo e populado -->
                    <select id="modalEmpresaSelect" name="empresa" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                        <option value="">Selecione uma empresa</option>
                        <!-- Opções de empresas serão inseridas aqui pelo JavaScript -->
                    </select>
                </div>
                <div class="mb-4">
                    <label for="modalAutenticacao" class="block text-sm font-medium text-gray-700 mb-1">Autenticado</label>
                    <select id="modalAutenticacao" name="autenticacao" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="SIM">SIM</option>
                        <option value="NÃO">NÃO</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="modalAcesso" class="block text-sm font-medium text-gray-700 mb-1">ACESSO</label>
                    <select id="modalAcesso" name="acesso" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                        <option value="">Selecione um tipo de acesso</option>
                        <!-- Opções de acesso serão inseridas aqui pelo JavaScript -->
                    </select>
                </div>
                <div class="mb-6">
                    <label for="modalSenha" class="block text-sm font-medium text-gray-700 mb-1">SENHA</label>
                    <input type="text" id="modalSenha" name="senha" class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed" value="" readonly>
                </div>

                <div class="flex justify-end gap-3">
                    <button type="button" id="cancelUserModal" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // URL do seu Google Apps Script para CARREGAR DADOS (gerenciador de cadastros.gs)
        const APPS_SCRIPT_DATA_URL = "https://script.google.com/macros/s/AKfycbyOk_uoXu7vtA-Hwju1CmM-N6e0wQ_2qEfKEDzVOsigjU-FdbLhvWF9vs623R1guoyykw/exec";
        // URL do seu Google Apps Script para ADICIONAR USUÁRIOS (adicionar_usuarios.gs)
        // ESTA É A URL QUE VOCÊ FORNECEU!
        const APPS_SCRIPT_ADD_USER_URL = "https://script.google.com/macros/s/AKfycbxUY6jnADNZ_3uZk8bvBBrkTJqDbY7e1BVqb0IIQpWCRkST5igK1CKfb51_4Cu6X4QXcQ/exec";


        // Variáveis globais para paginação e dados
        const itemsPerPage = 10;
        let currentPageUsuarios = 1;
        let currentPageEmpresas = 1;
        let allUsuariosData = [];
        let allEmpresasData = [];
        let allPermissoesData = [];

        // --- Variáveis para simular o usuário logado com persistência via localStorage ---
        // Estas variáveis serão definidas após a validação do localStorage
        let currentUserAccess = null;
        let currentUserCompany = null;
        // --- Fim das variáveis de simulação ---

        /**
         * Salva os dados do usuário atual no localStorage.
         * @param {string} access Nível de acesso do usuário.
         * @param {string} company Empresa do usuário.
         */
        function saveUserDataToLocalStorage(access, company) {
            localStorage.setItem('vigilonUserAccess', access);
            localStorage.setItem('vigilonUserCompany', company);
            updateCurrentUserInfoDisplay(); // Atualiza a exibição na UI
        }

        /**
         * Atualiza a exibição das informações do usuário atual na interface.
         */
        function updateCurrentUserInfoDisplay() {
            const userInfoElement = document.getElementById('currentUserInfo');
            if (userInfoElement) {
                const storedAccess = localStorage.getItem('vigilonUserAccess');
                const storedCompany = localStorage.getItem('vigilonUserCompany');

                // Atualiza as variáveis globais com o que está no localStorage
                currentUserAccess = storedAccess;
                currentUserCompany = storedCompany;

                if (currentUserAccess && currentUserCompany) {
                    if (currentUserAccess === "Master System") {
                        userInfoElement.textContent = `Acesso: ${currentUserAccess}`;
                    } else {
                        userInfoElement.textContent = `Acesso: ${currentUserAccess} | Empresa: ${currentUserCompany}`;
                    }
                }
            }
        }

        /**
         * Alterna a exibição das abas (Usuários/Empresas).
         * @param {string} tabId O ID da aba a ser mostrada ('usuarios' ou 'empresas').
         */
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            document.getElementById(tabId + 'Tab').classList.add('active');
            document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`).classList.add('active');

            // Ao mudar de aba, reseta a página para 1 e aplica os filtros atuais
            if (tabId === 'usuarios') {
                applyFiltersAndGoToPage('usuarios', 1);
            } else if (tabId === 'empresas') {
                applyFiltersAndGoToPage('empresas', 1);
            }
        }

        /**
         * Busca dados do Google Apps Script para uma aba específica.
         * @param {string} tabName O nome da aba ('Usuarios', 'Empresas' ou 'Permissoes').
         * @param {HTMLElement} loadingElement O elemento HTML para exibir a mensagem de carregamento.
         * @param {HTMLElement} errorElement O elemento HTML para exibir a mensagem de erro.
         * @returns {Promise<Array>} Uma promessa que resolve com os dados formatados ou rejeita em caso de erro.
         */
        async function fetchData(tabName, loadingElement, errorElement) {
            loadingElement.classList.remove('hidden');
            errorElement.classList.add('hidden');

            try {
                // Usa a URL de dados para requisições GET
                console.log(`fetchData: Tentando buscar dados da aba '${tabName}' em: ${APPS_SCRIPT_DATA_URL}?tab=${tabName}`);
                const response = await fetch(`${APPS_SCRIPT_DATA_URL}?tab=${tabName}`);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Erro HTTP: ${response.status} - ${response.statusText}. Detalhes: ${errorText.substring(0, 200)}...`);
                }
                const result = await response.json();

                if (result.status === 'sucesso') {
                    console.log(`fetchData: Dados recebidos para ${tabName}:`, result.data);
                    return result.data;
                } else {
                    throw new Error(result.message || 'Erro desconhecido retornado pelo script.');
                }
            } catch (error) {
                console.error(`fetchData: Erro ao buscar dados da aba ${tabName}:`, error);
                errorElement.textContent = `Erro ao carregar dados de ${tabName.toLowerCase()}: ${error.message}`;
                errorElement.classList.remove('hidden');
                return [];
            } finally {
                loadingElement.classList.add('hidden');
            }
        }

        /**
         * Filtra os dados com base no termo de pesquisa e status/autenticação.
         * @param {Array<Object>} data Os dados completos a serem filtrados.
         * @param {string} searchTerm O termo de pesquisa.
         * @param {string} statusFilter O valor do filtro ('Todos', 'SIM', 'NÃO' para usuários; 'Todos', 'Ativos', 'Inativos' para empresas).
         * @param {string} tabType O tipo de aba ('usuarios' ou 'empresas') para aplicar a lógica de filtro correta.
         * @returns {Array<Object>} Os dados filtrados.
         */
        function filterData(data, searchTerm, statusFilter, tabType) {
            let filtered = data;
            const lowerCaseSearchTerm = searchTerm.toLowerCase().trim();

            if (lowerCaseSearchTerm) {
                filtered = filtered.filter(item => {
                    if (tabType === 'usuarios') {
                        return (item.ID && String(item.ID).toLowerCase().includes(lowerCaseSearchTerm)) ||
                               (item['NOME/EQUIPE'] && String(item['NOME/EQUIPE']).toLowerCase().includes(lowerCaseSearchTerm)) ||
                               (item.EMPRESA && String(item.EMPRESA).toLowerCase().includes(lowerCaseSearchTerm));
                    } else if (tabType === 'empresas') {
                        return (item.CNPJ && String(item.CNPJ).toLowerCase().includes(lowerCaseSearchTerm)) ||
                               (item.NOME && String(item.NOME).toLowerCase().includes(lowerCaseSearchTerm)) ||
                               (item.PROPRIETARIO && String(item.PROPRIETARIO).toLowerCase().includes(lowerCaseSearchTerm));
                    }
                    return false;
                });
            }

            if (statusFilter !== 'Todos') {
                filtered = filtered.filter(item => {
                    if (tabType === 'usuarios') {
                        // Acessa a propriedade 'AUTENTICAÇÃO' com o caractere 'Ç'
                        return (item['AUTENTICAÇÃO'] && item['AUTENTICAÇÃO'].toUpperCase() === statusFilter.toUpperCase());
                    } else if (tabType === 'empresas') {
                        return (item.STATUS && item.STATUS.toLowerCase() === statusFilter.toLowerCase());
                    }
                    return true;
                });
            }
            return filtered;
        }

        /**
         * Renderiza os dados de usuários na tabela para a página atual.
         * @param {Array<Object>} data Os dados filtrados e paginados dos usuários a serem exibidos.
         */
        function renderUsuarios(data) {
            const tbody = document.querySelector('#usuariosTable tbody');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Nenhum usuário encontrado.</td></tr>';
                return;
            }
            data.forEach(usuario => {
                const row = tbody.insertRow();
                row.insertCell().textContent = usuario.ID || '';
                row.insertCell().textContent = usuario['NOME/EQUIPE'] || '';
                row.insertCell().textContent = usuario.EMPRESA || '';
                row.insertCell().textContent = usuario.ACESSO || '';
                // Acessa a propriedade 'AUTENTICAÇÃO' com o caractere 'Ç'
                row.insertCell().textContent = usuario['AUTENTICAÇÃO'] || '';

                const actionsCell = row.insertCell();
                actionsCell.className = 'action-buttons';
                actionsCell.innerHTML = `
                    <button title="Visualizar"><i class="fas fa-eye"></i></button>
                    <button title="Editar"><i class="fas fa-pencil-alt"></i></button>
                    <button title="Bloquear/Desbloquear"><i class="fas fa-lock"></i></button>
                    <button title="Deletar"><i class="fas fa-trash-alt"></i></button>
                `;
            });
        }

        /**
         * Renderiza os dados de empresas na tabela para a página atual.
         * @param {Array<Object>} data Os dados filtrados e paginados das empresas a serem exibidos.
         */
        function renderEmpresas(data) {
            const tbody = document.querySelector('#empresasTable tbody');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Nenhuma empresa encontrada.</td></tr>';
                return;
            }

            data.forEach(empresa => {
                const row = tbody.insertRow();
                row.insertCell().textContent = empresa.CNPJ || '';
                row.insertCell().textContent = empresa.NOME || '';
                row.insertCell().textContent = empresa.PROPRIETARIO || '';
                row.insertCell().textContent = empresa.STATUS || '';

                const actionsCell = row.insertCell();
                actionsCell.className = 'action-buttons';
                actionsCell.innerHTML = `
                    <button title="Visualizar"><i class="fas fa-eye"></i></button>
                    <button title="Editar"><i class="fas fa-pencil-alt"></i></button>
                    <button title="Deletar"><i class="fas fa-trash-alt"></i></button>
                `;
            });
        }

        /**
         * Atualiza os controles de paginação para uma aba específica.
         * @param {string} tabName O nome da aba ('usuarios' ou 'empresas').
         * @param {Array<Object>} filteredData Os dados filtrados (mas não paginados) para a aba.
         * @param {number} currentPage A página atual.
         */
        function updatePagination(tabName, filteredData, currentPage) {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const paginationInfoElement = document.getElementById(`${tabName}PaginationInfo`);
            const pageNumbersContainer = document.getElementById(`${tabName}PageNumbers`);

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredData.length);
            if (filteredData.length > 0) {
                paginationInfoElement.textContent = `Mostrando ${startIndex + 1} a ${endIndex} de ${filteredData.length} resultados`;
            } else {
                paginationInfoElement.textContent = `Mostrando 0 a 0 de 0 resultados`;
            }

            pageNumbersContainer.innerHTML = '';

            for (let i = 1; i <= totalPages; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.onclick = () => goToPage(tabName, i);
                if (i === currentPage) {
                    button.classList.add('active');
                }
                pageNumbersContainer.appendChild(button);
            }

            const prevButton = document.querySelector(`#${tabName}Pagination button:first-of-type`);
            const nextButton = document.querySelector(`#${tabName}Pagination button:last-of-type`);

            if (prevButton) prevButton.disabled = currentPage === 1 || totalPages === 0;
            if (nextButton) nextButton.disabled = currentPage === totalPages || totalPages === 0;
        }

        /**
         * Aplica filtros e navega para uma página específica, renderizando os dados.
         * Esta é a função principal chamada por eventos de filtro, pesquisa e paginação.
         * @param {string} tabName O nome da aba ('usuarios' ou 'empresas').
         * @param {number} pageNumber O número da página para navegar.
         */
        function applyFiltersAndGoToPage(tabName, pageNumber) {
            let dataToFilter;
            let searchTerm;
            let statusFilter;
            let currentPageVar;

            if (tabName === 'usuarios') {
                dataToFilter = allUsuariosData;
                searchTerm = document.getElementById('searchUserInput').value;
                statusFilter = document.getElementById('statusUserFilter').value;
                currentPageVar = currentPageUsuarios;
            } else if (tabName === 'empresas') {
                dataToFilter = allEmpresasData;
                searchTerm = document.getElementById('searchCompanyInput').value;
                statusFilter = document.getElementById('statusCompanyFilter').value;
                currentPageVar = currentPageEmpresas;
            }

            const filteredData = filterData(dataToFilter, searchTerm, statusFilter, tabName);

            // Garante que a página não exceda o total de páginas após a filtragem
            const totalPagesAfterFilter = Math.ceil(filteredData.length / itemsPerPage);
            const newPageNumber = Math.max(1, Math.min(pageNumber, totalPagesAfterFilter === 0 ? 1 : totalPagesAfterFilter));

            if (tabName === 'usuarios') {
                currentPageUsuarios = newPageNumber;
            } else if (tabName === 'empresas') {
                currentPageEmpresas = newPageNumber;
            }

            const startIndex = (newPageNumber - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedData = filteredData.slice(startIndex, endIndex);

            if (tabName === 'usuarios') {
                renderUsuarios(paginatedData);
                updatePagination('usuarios', filteredData, currentPageUsuarios);
            } else if (tabName === 'empresas') {
                renderEmpresas(paginatedData);
                updatePagination('empresas', filteredData, currentPageEmpresas);
            }
        }

        /**
         * Função wrapper para goToPage, para ser usada em onclick dos botões de paginação.
         * Simplesmente chama applyFiltersAndGoToPage com a página desejada.
         * @param {string} tabName
         * @param {number} pageNumber
         */
        function goToPage(tabName, pageNumber) {
            applyFiltersAndGoToPage(tabName, pageNumber);
        }

        // Referências aos elementos do modal
        const userModal = document.getElementById('userModal');
        const addUsuarioButton = document.getElementById('addUsuarioButton');
        const cancelUserModalButton = document.getElementById('cancelUserModal');
        const userForm = document.getElementById('userForm');
        const modalUsuarioInput = document.getElementById('modalUsuario');
        const modalSenhaInput = document.getElementById('modalSenha');
        const modalEmpresaSelect = document.getElementById('modalEmpresaSelect'); // Referência ao select de empresas
        const modalAcessoSelect = document.getElementById('modalAcesso'); // Referência ao select de acesso
        const modalMessage = document.getElementById('modalMessage'); // Referência à mensagem de erro/sucesso no modal

        // Referências para o conteúdo principal
        const mainContent = document.getElementById('mainContent');

        // Referência ao botão "Voltar"
        const backButton = document.getElementById('backButton');

        /**
         * Exibe uma mensagem no modal (erro ou sucesso).
         * @param {string} message A mensagem a ser exibida.
         * @param {string} type O tipo da mensagem ('error' ou 'success').
         */
        function showModalMessage(message, type) {
            modalMessage.textContent = message;
            modalMessage.className = `message-box ${type}`; // Adiciona as classes de estilo
            modalMessage.classList.remove('hidden');
        }

        /**
         * Oculta a mensagem no modal.
         */
        function hideModalMessage() {
            modalMessage.classList.add('hidden');
            modalMessage.textContent = '';
            modalMessage.className = 'message-box hidden'; // Remove as classes de estilo
        }

        /**
         * Popula o select de empresas com os nomes das empresas cadastradas.
         */
        function populateEmpresasSelect() {
            modalEmpresaSelect.innerHTML = '<option value="">Selecione uma empresa</option>'; // Limpa e adiciona opção padrão
            const uniqueCompanyNames = [...new Set(allEmpresasData.map(empresa => empresa.NOME).filter(name => name))];
            uniqueCompanyNames.sort().forEach(name => { // Opcional: ordena alfabeticamente
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                modalEmpresaSelect.appendChild(option);
            });

            // Se o usuário atual tiver uma empresa associada, pré-seleciona-a
            if (currentUserCompany && uniqueCompanyNames.includes(currentUserCompany)) {
                modalEmpresaSelect.value = currentUserCompany;
            }
        }

        /**
         * Popula o select de acesso com TODOS os tipos de acesso da aba 'Permissões'.
         * A filtragem por empresa foi removida conforme solicitação.
         */
        function populateAcessoSelect() {
            modalAcessoSelect.innerHTML = '<option value="">Selecione um tipo de acesso</option>'; // Limpa e adiciona opção padrão

            // Mapeia todos os tipos de acesso da aba 'Permissões'
            const allAccessTypes = allPermissoesData
                .map(perm => perm['TIPO DE ACESSO'])
                .filter(type => type); // Filtra valores vazios/nulos

            // Remove duplicatas e ordena alfabeticamente
            const uniqueAccessTypes = [...new Set(allAccessTypes)].sort();

            uniqueAccessTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                modalAcessoSelect.appendChild(option);
            });
        }

        /**
         * Abre o modal de cadastro de usuário e desativa a rolagem da tela.
         */
        function openUserModal() {
            userModal.classList.add('active');
            document.body.style.overflow = 'hidden'; // Desativa a rolagem
            userForm.reset(); // Reseta todos os campos do formulário para limpar estados anteriores
            modalSenhaInput.value = ""; // Garante que a senha comece em branco
            hideModalMessage(); // Oculta qualquer mensagem anterior

            // O campo EMPRESA (select) agora está sempre visível e ativo
            modalEmpresaSelect.classList.remove('hidden');
            modalEmpresaSelect.setAttribute('required', 'true');
            modalEmpresaSelect.disabled = false; // Garante que o select esteja ativo
            populateEmpresasSelect(); // Popula o select de empresas

            // Popula o select de acesso com TODOS os tipos de acesso (sem filtro)
            populateAcessoSelect();
        }

        /**
         * Fecha o modal de cadastro de usuário, reseta o formulário e ativa a rolagem da tela.
         */
        function closeUserModal() {
            userModal.classList.remove('active');
            document.body.style.overflow = ''; // Ativa a rolagem
            userForm.reset(); // Reseta todos os campos do formulário
            hideModalMessage(); // Oculta qualquer mensagem

            // Garante que o select de empresa esteja resetado e desativado ao fechar
            modalEmpresaSelect.innerHTML = '<option value="">Selecione uma empresa</option>';
            modalEmpresaSelect.removeAttribute('required');
            modalEmpresaSelect.disabled = true; // Desativa o select ao fechar

            // Limpa e reseta o select de acesso
            modalAcessoSelect.innerHTML = '<option value="">Selecione um tipo de acesso</option>';
        }

        /**
         * Envia os dados do novo usuário para o Google Apps Script.
         * @param {Object} userData Os dados do usuário a serem enviados.
         * @returns {Promise<Object>} Uma promessa que resolve com o resultado da operação.
         */
        async function sendUserDataToAppsScript(userData) {
            showModalMessage('Enviando dados...', 'loading'); // Exibe mensagem de carregamento

            try {
                // Loga a URL e os dados para depuração
                console.log('sendUserDataToAppsScript: Tentando enviar dados para:', APPS_SCRIPT_ADD_USER_URL);
                console.log('sendUserDataToAppsScript: Dados a serem enviados:', JSON.stringify(userData, null, 2));

                const response = await fetch(APPS_SCRIPT_ADD_USER_URL, {
                    method: 'POST',
                    mode: 'cors', // Necessário para requisições CORS
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('sendUserDataToAppsScript: Resposta HTTP não OK:', response.status, response.statusText, errorText);
                    throw new Error(`Erro HTTP: ${response.status} - ${response.statusText}. Detalhes: ${errorText.substring(0, 200)}...`);
                }

                const result = await response.json();
                console.log('sendUserDataToAppsScript: Resultado da resposta do Apps Script:', result);


                if (result.status === 'sucesso') {
                    showModalMessage(result.message, 'success');
                    // Recarrega os dados de usuários após o cadastro bem-sucedido
                    allUsuariosData = await fetchData('Usuarios', document.getElementById('loadingUsuarios'), document.getElementById('errorUsuarios'));
                    applyFiltersAndGoToPage('usuarios', 1); // Atualiza a tabela
                    setTimeout(closeUserModal, 2000); // Fecha o modal após 2 segundos
                } else {
                    showModalMessage(result.message || 'Erro desconhecido ao cadastrar usuário.', 'error');
                }
                return result;
            } catch (error) {
                console.error('sendUserDataToAppsScript: Erro ao enviar dados do usuário (catch):', error);
                // Mensagem mais específica para "Failed to fetch"
                if (error instanceof TypeError && error.message.includes('Failed to fetch')) {
                    showModalMessage(`Erro de conexão: Não foi possível alcançar o servidor. Verifique se a URL do Google Apps Script para adicionar usuários está correta e se o script foi implantado como aplicativo da web com acesso "Qualquer pessoa". Detalhes: ${error.message}.`, 'error');
                } else {
                    showModalMessage(`Erro ao cadastrar usuário: ${error.message}`, 'error');
                }
                return { status: 'erro', message: error.message };
            }
        }


        /**
         * Carrega os dados do usuário do localStorage e inicializa o painel.
         * Não há redirecionamento se os dados estiverem ausentes.
         */
        async function initializeDashboard() {
            updateCurrentUserInfoDisplay(); // Tenta carregar e exibir as informações do usuário

            // Loga as URLs do Apps Script no console para facilitar a depuração
            console.log('initializeDashboard: URL do Google Apps Script para Dados (GET):', APPS_SCRIPT_DATA_URL);
            console.log('initializeDashboard: URL do Google Apps Script para Adicionar Usuário (POST):', APPS_SCRIPT_ADD_USER_URL);


            const loadingUsuarios = document.getElementById('loadingUsuarios');
            const errorUsuarios = document.getElementById('errorUsuarios');
            const loadingEmpresas = document.getElementById('loadingEmpresas');
            const errorEmpresas = document.getElementById('errorEmpresas');
            const loadingPermissoes = document.getElementById('loadingUsuarios'); // Reutilizando elementos de loading/erro
            const errorPermissoes = document.getElementById('errorUsuarios'); // Reutilizando elementos de loading/erro

            // fetchData agora usa APPS_SCRIPT_DATA_URL
            allUsuariosData = await fetchData('Usuarios', loadingUsuarios, errorUsuarios);
            allEmpresasData = await fetchData('Empresas', loadingEmpresas, errorEmpresas);
            allPermissoesData = await fetchData('Permissões', loadingPermissoes, errorPermissoes);

            showTab('usuarios'); // Garante que a aba de usuários é a primeira a ser mostrada
        }

        // Adiciona event listeners para os campos de pesquisa e filtros de status
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('searchUserInput').addEventListener('input', () => applyFiltersAndGoToPage('usuarios', 1));
            document.getElementById('statusUserFilter').addEventListener('change', () => applyFiltersAndGoToPage('usuarios', 1));

            document.getElementById('searchCompanyInput').addEventListener('input', () => applyFiltersAndGoToPage('empresas', 1));
            document.getElementById('statusCompanyFilter').addEventListener('change', () => applyFiltersAndGoToPage('empresas', 1));

            // Event listeners para o modal
            addUsuarioButton.addEventListener('click', openUserModal);
            cancelUserModalButton.addEventListener('click', closeUserModal);
            userModal.addEventListener('click', (e) => {
                // Fecha o modal se clicar fora do conteúdo do modal
                if (e.target === userModal) {
                    closeUserModal();
                }
            });

            // Event listener para o campo USUÁRIO para preencher a SENHA dinamicamente
            modalUsuarioInput.addEventListener('input', () => {
                if (modalUsuarioInput.value.trim() !== "") {
                    modalSenhaInput.value = modalUsuarioInput.value + "@MudarSenha1999";
                } else {
                    modalSenhaInput.value = "";
                }
            });

            // Lidar com o envio do formulário
            userForm.addEventListener('submit', async (e) => { // Tornar a função assíncrona
                e.preventDefault(); // Impede o envio padrão do formulário
                hideModalMessage(); // Oculta qualquer mensagem antes de validar

                const formData = new FormData(userForm);
                const userData = {};

                userData.empresa = modalEmpresaSelect.value;
                userData.usuario = formData.get('usuario');
                userData.nome = formData.get('nome');
                userData.autenticacao = formData.get('autenticacao');
                userData.acesso = formData.get('acesso');
                userData.senha = formData.get('senha');

                // --- Regra de Validação: Cadastrar Master System ---
                if (userData.acesso === "Master System" && currentUserAccess !== "Master System") {
                    showModalMessage('Erro: Somente usuários "Master System" podem cadastrar outros usuários "Master System".', 'error');
                    return; // Impede o envio do formulário
                }
                // --- Fim da Regra de Validação ---

                // Chama a função para enviar os dados para o Google Apps Script
                await sendUserDataToAppsScript(userData);
            });

            // Event listener para o botão "Voltar"
            backButton.addEventListener('click', () => {
                window.location.href = "dashboard.html";
            });

            // Executa quando a página é totalmente carregada
            initializeDashboard();
        });
    </script>
</body>
</html>
