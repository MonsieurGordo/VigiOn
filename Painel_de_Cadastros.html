<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Cadastros VigiOn</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome para ícones de ações -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            color: #374151; /* Dark gray text */
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        table {
            width: 100%; /* Garante que a tabela ocupe a largura total do seu contêiner */
            border-collapse: collapse;
            margin-top: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 0.5rem;
            overflow: hidden; /* Ensures rounded corners are applied to table content */
            table-layout: auto; /* Permite que as colunas se ajustem ao conteúdo */
        }
        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb; /* Light gray border */
            /* Adicionado para ajudar no redimensionamento de colunas */
            white-space: normal; /* Permite que o texto quebre linha */
            word-break: break-word; /* Força a quebra de palavras longas */
        }
        th {
            background-color: #F7FAFC; /* Light background for table header */
            color: #374151; /* Dark text for contrast */
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }
        tr:nth-child(even) {
            background-color: #f9fafb; /* Lighter gray for even rows */
        }
        tr:hover {
            background-color: #e0e7ff; /* Light blue on hover */
            transition: background-color 0.2s ease-in-out;
        }
        .message-box {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            font-weight: 500;
        }
        .message-box.loading {
            background-color: #bfdbfe; /* Blue 200 */
            color: #1e40af; /* Blue 800 */
            border: 1px solid #93c5fd; /* Blue 300 */
        }
        .message-box.error {
            background-color: #fecaca; /* Red 200 */
            color: #b91c1c; /* Red 800 */
            border: 1px solid #fca5a5; /* Red 300 */
        }
        .message-box.success {
            background-color: #d1fae5; /* Green 200 */
            color: #065f46; /* Green 800 */
            border: 1px solid #a7f3d0; /* Green 300 */
        }
        /* Estilos para as abas */
        .tab-buttons {
            display: flex;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e5e7eb;
        }
        .tab-button {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            font-weight: 600;
            color: #6b7280; /* Gray 500 */
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease-in-out;
        }
        .tab-button.active {
            color: #4f46e5; /* Indigo 600 */
            border-color: #4f46e5;
        }
        .header-bar {
            background-color: #5A73D4; /* Alterado para o novo tom de azul */
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.5rem 0.5rem 0 0; /* Rounded top corners */
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .header-bar h1 {
            font-size: 1.75rem; /* text-2xl */
            font-weight: 700; /* font-bold */
        }
        .add-button {
            background-color: #6200EE; /* Deep Purple */
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 9999px; /* Full rounded */
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background-color 0.2s ease-in-out;
        }
        .add-button:hover {
            background-color: #5200D1; /* Slightly darker purple on hover */
        }
        .filter-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background-color: #f9fafb;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            flex-wrap: wrap; /* Permite que os itens quebrem para a próxima linha em telas pequenas */
            gap: 1rem; /* Espaçamento entre os itens do filtro */
        }
        .filter-section input,
        .filter-section select {
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            color: #374151;
            background-color: white;
            flex-grow: 1; /* Permite que os inputs e selects cresçam */
            min-width: 150px; /* Largura mínima para inputs */
        }
        .filter-section select {
            max-width: 150px; /* Largura máxima para o select de status */
        }
        .filter-section input:focus,
        .filter-section select:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .action-buttons {
            white-space: nowrap; /* Garante que os botões não quebrem linha */
        }
        .action-buttons button {
            background: none;
            border: none;
            cursor: pointer;
            color: #6b7280;
            margin-right: 0.75rem; /* Aumenta o espaçamento entre os ícones */
            font-size: 0.95rem; /* Reduz ligeiramente o tamanho dos ícones */
            transition: color 0.2s ease-in-out;
        }
        .action-buttons button:last-child {
            margin-right: 0; /* Remove margem do último botão */
        }
        .action-buttons button:hover {
            color: #4f46e5;
        }
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 1.5rem;
            gap: 0.5rem;
        }
        .pagination button {
            background-color: #e5e7eb;
            color: #4b5563;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .pagination button:hover:not(.active):not(:disabled) { /* Adicionado :not(:disabled) */
            background-color: #d1d5db;
        }
        .pagination button.active {
            background-color: #4f46e5;
            color: white;
        }
        .pagination button:disabled { /* Estilo para botões desabilitados */
            opacity: 0.6;
            cursor: not-allowed;
        }
        .pagination-info {
            font-size: 0.875rem;
            color: #6b7280;
        }
        .back-button {
            background-color: #ef4444; /* Red 500 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background-color 0.2s ease-in-out;
            margin-top: 2rem;
            float: right; /* Alinha à direita */
        }
        .back-button:hover {
            background-color: #dc2626; /* Red 600 */
        }

        /* Estilos do Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5); /* Fundo semi-transparente escuro */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000; /* Garante que o modal fique acima de outros elementos */
            opacity: 0; /* Inicialmente invisível */
            visibility: hidden; /* Esconde completamente para não interferir com eventos de clique */
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 500px; /* Largura máxima para o modal */
            transform: translateY(-20px); /* Começa um pouco acima */
            transition: transform 0.3s ease-in-out;
            max-height: 90vh; /* Limita a altura do modal */
            overflow-y: auto; /* Adiciona barra de rolagem vertical se o conteúdo exceder */
        }
        .modal-overlay.active .modal-content {
            transform: translateY(0); /* Desliza para a posição final */
        }
        /* Estilo para a mensagem de erro dentro do modal */
        #modalErrorMessage, #modalSuccessMessage {
            padding: 0.75rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }
        #modalErrorMessage {
            background-color: #fecaca; /* Red 200 */
            color: #b91c1c; /* Red 800 */
            border: 1px solid #fca5a5; /* Red 300 */
        }
        #modalSuccessMessage {
            background-color: #d1fae5; /* Green 200 */
            color: #065f46; /* Green 800 */
            border: 1px solid #a7f3d0; /* Green 300 */
        }
        /* Estilo para o grid de campos do modal de empresa */
        .company-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* 2 colunas responsivas */
            gap: 1rem; /* Espaçamento entre os campos */
        }
        .company-form-grid > div {
            margin-bottom: 0 !important; /* Remove margem inferior padrão dos divs internos */
        }
    </style>
</head>
<body class="antialiased">
    <!-- Conteúdo Principal do Painel -->
    <div id="mainContent" class="container">
        <header class="header-bar">
            <h1>Painel de Cadastros</h1>
            <div class="flex items-center gap-4">
                <span id="currentUserInfo" class="text-sm font-medium"></span>
                <button id="addCompanyButton" class="add-button hidden">
                    <i class="fas fa-building"></i> Adicionar Empresa
                </button>
                <button id="addUsuarioButton" class="add-button">
                    <i class="fas fa-plus"></i> Adicionar
                </button>
            </div>
        </header>

        <div class="bg-white p-6 rounded-b-lg shadow-md mb-8">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="showTab('usuarios')">Usuários</button>
                <button class="tab-button" onclick="showTab('empresas')">Empresas</button>
            </div>

            <div id="usuariosTab" class="tab-content active">
                <div class="filter-section">
                    <input type="text" id="searchUserInput" placeholder="Pesquisar por nome...">
                    <div class="flex items-center gap-2">
                        <span>Autenticado:</span>
                        <select id="statusUserFilter">
                            <option value="Todos">Todos</option>
                            <option value="SIM">SIM</option>
                            <option value="NÃO">NÃO</option>
                        </select>
                    </div>
                </div>
                <div id="loadingUsuarios" class="message-box loading">
                    Carregando dados de usuários...
                </div>
                <div id="errorUsuarios" class="message-box error hidden">
                    Erro ao carregar dados de usuários.
                </div>
                <!-- Removida a classe overflow-x-auto do contêiner da tabela de usuários -->
                <div id="usuariosTableContainer">
                    <table id="usuariosTable" class="min-w-full">
                        <thead>
                            <tr>
                                <th>USUÁRIO</th>
                                <th>NOME</th>
                                <th>EMPRESA</th>
                                <th>ACESSO</th>
                                <th>AUTENTICADO</th>
                                <th>AÇÕES</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dados dos usuários serão inseridos aqui pelo JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div id="usuariosPagination" class="pagination">
                    <span id="usuariosPaginationInfo" class="pagination-info"></span>
                    <button onclick="goToPage('usuarios', currentPageUsuarios - 1)">&lt;</button>
                    <div id="usuariosPageNumbers" class="flex gap-2">
                        <!-- Números das páginas serão inseridos aqui -->
                    </div>
                    <button onclick="goToPage('usuarios', currentPageUsuarios + 1)">&gt;</button>
                </div>
            </div>

            <div id="empresasTab" class="tab-content">
                <div class="filter-section">
                    <input type="text" id="searchCompanyInput" placeholder="Pesquisar por nome...">
                    <div class="flex items-center gap-2">
                        <span>Status:</span>
                        <select id="statusCompanyFilter">
                            <option value="Todos">Todos</option>
                            <option value="Ativos">Ativos</option>
                            <option value="Inativos">Inativos</option>
                        </select>
                    </div>
                </div>

                <div id="loadingEmpresas" class="message-box loading">
                    Carregando dados de empresas...
                </div>
                <div id="errorEmpresas" class="message-box error hidden">
                    Erro ao carregar dados de empresas.
                </div>
                <!-- Removida a classe overflow-x-auto do contêiner da tabela de empresas -->
                <div id="empresasTableContainer">
                    <table id="empresasTable" class="min-w-full">
                        <thead>
                            <tr>
                                <th>CNPJ</th>
                                <th>NOME</th>
                                <th>PROPRIETARIO</th>
                                <th>STATUS</th>
                                <th>AÇÕES</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dados das empresas serão inseridos aqui pelo JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div id="empresasPagination" class="pagination">
                    <span id="empresasPaginationInfo" class="pagination-info"></span>
                    <button onclick="goToPage('empresas', currentPageEmpresas - 1)">&lt;</button>
                    <div id="empresasPageNumbers" class="flex gap-2">
                        <!-- Números das páginas serão inseridos aqui -->
                    </div>
                    <button onclick="goToPage('empresas', currentPageEmpresas + 1)">&gt;</button>
                </div>
            </div>
            <button id="backButton" class="back-button">
                <i class="fas fa-arrow-left"></i> Voltar
            </button>
        </div>
    </div>

    <!-- Modal para Cadastrar/Editar Usuário -->
    <div id="userModal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="userModalTitle" class="text-2xl font-bold mb-6 text-gray-800">Cadastrar Usuário</h2>

            <!-- Mensagens de erro e sucesso dentro do modal -->
            <div id="modalErrorMessage" class="message-box error hidden"></div>
            <div id="modalSuccessMessage" class="message-box success hidden"></div>
            <div id="modalLoadingMessage" class="message-box loading hidden">Processando...</div>


            <form id="userForm">
                <!-- Campo oculto para armazenar o ID do usuário em caso de edição -->
                <input type="hidden" id="modalUserId" name="id">

                <div class="mb-4">
                    <label for="modalUsuario" class="block text-sm font-medium text-gray-700 mb-1">USUÁRIO</label>
                    <input type="text" id="modalUsuario" name="usuario" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div class="mb-4">
                    <label for="modalNome" class="block text-sm font-medium text-gray-700 mb-1">NOME</label>
                    <input type="text" id="modalNome" name="nome" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div class="mb-4">
                    <label for="modalEmpresa" class="block text-sm font-medium text-gray-700 mb-1">EMPRESA</label>
                    <!-- Agora apenas um select para empresa, sempre ativo e populado -->
                    <select id="modalEmpresaSelect" name="empresa" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                        <option value="">Selecione uma empresa</option>
                        <!-- Opções de empresas serão inseridas aqui pelo JavaScript -->
                    </select>
                </div>
                <div class="mb-4">
                    <label for="modalAutenticacao" class="block text-sm font-medium text-gray-700 mb-1">Autenticado</label>
                    <select id="modalAutenticacao" name="autenticacao" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="SIM">SIM</option>
                        <option value="NÃO">NÃO</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="modalAcesso" class="block text-sm font-medium text-gray-700 mb-1">ACESSO</label>
                    <select id="modalAcesso" name="acesso" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                        <option value="">Selecione um tipo de acesso</option>
                        <!-- Opções de acesso serão inseridas aqui pelo JavaScript -->
                    </select>
                </div>
                <div class="mb-6">
                    <label for="modalSenha" class="block text-sm font-medium text-gray-700 mb-1">SENHA</label>
                    <input type="text" id="modalSenha" name="senha" class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed" value="" readonly>
                </div>

                <div class="flex justify-end gap-3">
                    <button type="button" id="cancelUserModal" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">Cancelar</button>
                    <button type="submit" id="submitUserFormButton" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Novo Modal para Cadastrar/Editar Empresa -->
    <div id="companyModal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="companyModalTitle" class="text-2xl font-bold mb-6 text-gray-800">Cadastrar Empresa</h2>

            <!-- Mensagens de erro e sucesso dentro do modal -->
            <div id="companyModalErrorMessage" class="message-box error hidden"></div>
            <div id="companyModalSuccessMessage" class="message-box success hidden"></div>
            <div id="companyModalLoadingMessage" class="message-box loading hidden">Processando...</div>

            <form id="companyForm">
                <!-- Campo oculto para armazenar o CNPJ da empresa em caso de edição -->
                <input type="hidden" id="modalCompanyCnpj" name="cnpjOriginal">

                <div class="company-form-grid">
                    <div class="mb-4">
                        <label for="modalCnpj" class="block text-sm font-medium text-gray-700 mb-1">CNPJ</label>
                        <input type="text" id="modalCnpj" name="cnpj" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div class="mb-4">
                        <label for="modalCompanyName" class="block text-sm font-medium text-gray-700 mb-1">NOME</label>
                        <input type="text" id="modalCompanyName" name="nome" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div class="mb-4">
                        <label for="modalCompanyInscricaoEstadual" class="block text-sm font-medium text-gray-700 mb-1">INSCRIÇÃO ESTADUAL</label>
                        <input type="text" id="modalCompanyInscricaoEstadual" name="inscricaoEstadual" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="modalCompanyDataAbertura" class="block text-sm font-medium text-gray-700 mb-1">DATA DE ABERTURA</label>
                        <input type="date" id="modalCompanyDataAbertura" name="dataAbertura" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="modalCompanyEmail" class="block text-sm font-medium text-gray-700 mb-1">E-MAIL</label>
                        <input type="email" id="modalCompanyEmail" name="email" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="modalCompanyCep" class="block text-sm font-medium text-gray-700 mb-1">CEP</label>
                        <input type="text" id="modalCompanyCep" name="cep" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="modalCompanyEndereco" class="block text-sm font-medium text-gray-700 mb-1">ENDEREÇO</label>
                        <input type="text" id="modalCompanyEndereco" name="endereco" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="modalCompanyNumero" class="block text-sm font-medium text-gray-700 mb-1">NÚMERO</label>
                        <input type="text" id="modalCompanyNumero" name="numero" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="modalCompanyBairro" class="block text-sm font-medium text-gray-700 mb-1">BAIRRO</label>
                        <input type="text" id="modalCompanyBairro" name="bairro" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="modalCompanyCidade" class="block text-sm font-medium text-gray-700 mb-1">CIDADE</label>
                        <input type="text" id="modalCompanyCidade" name="cidade" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="modalCompanyEstado" class="block text-sm font-medium text-gray-700 mb-1">ESTADO</label>
                        <input type="text" id="modalCompanyEstado" name="estado" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="modalCompanyTelefone" class="block text-sm font-medium text-gray-700 mb-1">TELEFONE</label>
                        <input type="text" id="modalCompanyTelefone" name="telefone" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="modalCompanyOwner" class="block text-sm font-medium text-gray-700 mb-1">PROPRIETARIO</label>
                        <input type="text" id="modalCompanyOwner" name="proprietario" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div class="mb-4">
                        <label for="modalCompanyStatus" class="block text-sm font-medium text-gray-700 mb-1">STATUS</label>
                        <select id="modalCompanyStatus" name="status" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="Ativa">ATIVA</option>
                            <option value="Inativa">INATIVA</option>
                            <option value="Bloqueada">BLOQUEADA</option>
                        </select>
                    </div>
                </div>

                <div class="flex justify-end gap-3 mt-6"> <!-- Adicionado mt-6 para espaçamento -->
                    <button type="button" id="cancelCompanyModal" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">Cancelar</button>
                    <button type="submit" id="submitCompanyFormButton" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirmação Genérico -->
    <div id="confirmationModal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4 text-gray-800">Confirmação</h2>
            <p id="confirmationMessage" class="mb-6 text-gray-700"></p>
            <div class="flex justify-end gap-3">
                <button type="button" id="cancelConfirmation" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">Cancelar</button>
                <button type="button" id="confirmAction" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">Confirmar</button>
            </div>
        </div>
    </div>


    <script>
        // URL do seu Google Apps Script implementado
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzu7e1CBDQT8mC1ceyysudysarVF9JPHaL6cDvsnKFVAy8XNf9B1UbVwuUeTWHU2-cP/exec";

        // Variáveis globais para paginação e dados
        const itemsPerPage = 10;
        let currentPageUsuarios = 1;
        let currentPageEmpresas = 1;
        let allUsuariosData = [];
        let allEmpresasData = [];
        let allPermissoesData = [];

        // --- Variáveis para simular o usuário logado com persistência via localStorage ---
        // Estas variáveis serão definidas após a validação do localStorage
        let currentUserAccess = null;
        let currentUserCompany = null;
        // --- Fim das variáveis de simulação ---

        // Referências aos botões de adicionar
        const addUsuarioButton = document.getElementById('addUsuarioButton');
        const addCompanyButton = document.getElementById('addCompanyButton');


        /**
         * Salva os dados do usuário atual no localStorage.
         * @param {string} access Nível de acesso do usuário.
         * @param {string} company Empresa do usuário.
         */
        function saveUserDataToLocalStorage(access, company) {
            localStorage.setItem('vigilonUserAccess', access);
            localStorage.setItem('vigilonUserCompany', company);
            updateCurrentUserInfoDisplay(); // Atualiza a exibição na UI
        }

        /**
         * Atualiza a exibição das informações do usuário atual na interface.
         */
        function userInfoElement() {
            const userInfoElement = document.getElementById('currentUserInfo');
            if (userInfoElement) {
                const storedAccess = localStorage.getItem('vigilonUserAccess');
                const storedCompany = localStorage.getItem('vigilonUserCompany');

                // Atualiza as variáveis globais com o que está no localStorage
                currentUserAccess = storedAccess;
                currentUserCompany = storedCompany;

                if (currentUserAccess && currentUserCompany) {
                    if (currentUserAccess === "Master System") {
                        userInfoElement.textContent = `Acesso: ${currentUserAccess}`;
                    } else {
                        userInfoElement.textContent = `Acesso: ${currentUserAccess} | Empresa: ${currentUserCompany}`;
                    }
                }
            }
        }

        /**
         * Alterna a exibição das abas (Usuários/Empresas) e a visibilidade dos botões de adicionar.
         * @param {string} tabId O ID da aba a ser mostrada ('usuarios' ou 'empresas').
         */
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            document.getElementById(tabId + 'Tab').classList.add('active');
            document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`).classList.add('active');

            // Lógica para esconder/mostrar os botões de adicionar
            if (tabId === 'usuarios') {
                addUsuarioButton.classList.remove('hidden');
                addCompanyButton.classList.add('hidden');
            } else if (tabId === 'empresas') {
                addUsuarioButton.classList.add('hidden');
                addCompanyButton.classList.remove('hidden');
            }

            // Ao mudar de aba, reseta a página para 1 e aplica os filtros atuais
            if (tabId === 'usuarios') {
                applyFiltersAndGoToPage('usuarios', 1);
            } else if (tabId === 'empresas') {
                applyFiltersAndGoToPage('empresas', 1);
            }
        }

        /**
         * Busca dados do Google Apps Script para uma aba específica.
         * @param {string} tabName O nome da aba ('Usuarios', 'Empresas' ou 'Permissoes').
         * @param {HTMLElement} loadingElement O elemento HTML para exibir a mensagem de carregamento.
         * @param {HTMLElement} errorElement O elemento HTML para exibir a mensagem de erro.
         * @returns {Promise<Array>} Uma promessa que resolve com os dados formatados ou rejeita em caso de erro.
         */
        async function fetchData(tabName, loadingElement, errorElement) {
            loadingElement.classList.remove('hidden');
            errorElement.classList.add('hidden');

            try {
                console.log(`DEBUG: Tentando fetchData para ${tabName}. URL: ${APPS_SCRIPT_URL}?tab=${tabName}`);
                const response = await fetch(`${APPS_SCRIPT_URL}?tab=${tabName}`, {
                    mode: 'cors' // Explicitly set CORS mode for GET requests as well
                });

                console.log(`DEBUG: Resposta de fetchData para ${tabName}:`, response);
                console.log(`DEBUG: Access-Control-Allow-Origin header para ${tabName}:`, response.headers.get('Access-Control-Allow-Origin'));


                if (!response.ok) {
                    let errorText = await response.text();
                    console.error(`DEBUG: Resposta não OK para ${tabName}. Status: ${response.status}, Texto: ${errorText}`);
                    throw new Error(`Erro HTTP: ${response.status} - ${response.statusText}. Detalhes: ${errorText.substring(0, 200)}...`);
                }
                const result = await response.json();

                if (result.status === 'sucesso') {
                    console.log(`Dados recebidos para ${tabName}:`, result.data);
                    return result.data;
                } else {
                    console.error(`DEBUG: Erro no resultado do script para ${tabName}:`, result.message);
                    throw new Error(result.message || 'Erro desconhecido retornado pelo script.');
                }
            } catch (error) {
                console.error(`Erro ao buscar dados da aba ${tabName}:`, error);
                errorElement.textContent = `Erro ao carregar dados de ${tabName.toLowerCase()}: ${error.message}`;
                errorElement.classList.remove('hidden');
                return [];
            } finally {
                loadingElement.classList.add('hidden');
            }
        }

        /**
         * Filtra os dados com base no termo de pesquisa e status/autenticação.
         * @param {Array<Object>} data Os dados completos a serem filtrados.
         * @param {string} searchTerm O termo de pesquisa.
         * @param {string} statusFilter O valor do filtro ('Todos', 'SIM', 'NÃO' para usuários; 'Todos', 'Ativos', 'Inativos' para empresas).
         * @param {string} tabType O tipo de aba ('usuarios' ou 'empresas') para aplicar a lógica de filtro correta.
         * @returns {Array<Object>} Os dados filtrados.
         */
        function filterData(data, searchTerm, statusFilter, tabType) {
            let filtered = data;
            const lowerCaseSearchTerm = searchTerm.toLowerCase().trim();

            if (lowerCaseSearchTerm) {
                filtered = filtered.filter(item => {
                    if (tabType === 'usuarios') {
                        return (item.ID && String(item.ID).toLowerCase().includes(lowerCaseSearchTerm)) ||
                               (item['NOME/EQUIPE'] && String(item['NOME/EQUIPE']).toLowerCase().includes(lowerCaseSearchTerm)) ||
                               (item.EMPRESA && String(item.EMPRESA).toLowerCase().includes(lowerCaseSearchTerm));
                    } else if (tabType === 'empresas') {
                        return (item.CNPJ && String(item.CNPJ).toLowerCase().includes(lowerCaseSearchTerm)) ||
                               (item.NOME && String(item.NOME).toLowerCase().includes(lowerCaseSearchTerm)) ||
                               (item.PROPRIETARIO && String(item.PROPRIETARIO).toLowerCase().includes(lowerCaseSearchTerm));
                    }
                    return false;
                });
            }

            if (statusFilter !== 'Todos') {
                filtered = filtered.filter(item => {
                    if (tabType === 'usuarios') {
                        // Acessa a propriedade 'AUTENTICAÇÃO' com o caractere 'Ç'
                        return (item['AUTENTICAÇÃO'] && item['AUTENTICAÇÃO'].toUpperCase() === statusFilter.toUpperCase());
                    } else if (tabType === 'empresas') {
                        return (item.STATUS && item.STATUS.toLowerCase() === statusFilter.toLowerCase());
                    }
                    return true;
                });
            }
            return filtered;
        }

        /**
         * Renderiza os dados de usuários na tabela para a página atual.
         * @param {Array<Object>} data Os dados filtrados e paginados dos usuários a serem exibidos.
         */
        function renderUsuarios(data) {
            const tbody = document.querySelector('#usuariosTable tbody');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Nenhum usuário encontrado.</td></tr>';
                return;
            }
            data.forEach(usuario => {
                const row = tbody.insertRow();
                row.insertCell().textContent = usuario.ID || '';
                row.insertCell().textContent = usuario['NOME/EQUIPE'] || '';
                row.insertCell().textContent = usuario.EMPRESA || '';
                row.insertCell().textContent = usuario.ACESSO || '';
                // Acessa a propriedade 'AUTENTICAÇÃO' com o caractere 'Ç'
                row.insertCell().textContent = usuario['AUTENTICAÇÃO'] || '';

                const actionsCell = row.insertCell();
                actionsCell.className = 'action-buttons';
                // Adicionando event listeners aos botões de ação
                actionsCell.innerHTML = `
                    <button title="Visualizar" data-id="${usuario.ID}" onclick="viewUser('${usuario.ID}')"><i class="fas fa-eye"></i></button>
                    <button title="Editar" data-id="${usuario.ID}" onclick="editUser('${usuario.ID}')"><i class="fas fa-pencil-alt"></i></button>
                    <button title="Bloquear/Desbloquear" data-id="${usuario.ID}"><i class="fas fa-lock"></i></button>
                    <button title="Deletar" data-id="${usuario.ID}" onclick="deleteUser('${usuario.ID}')"><i class="fas fa-trash-alt"></i></button>
                `;
            });
        }

        /**
         * Renderiza os dados de empresas na tabela para a página atual.
         * @param {Array<Object>} data Os dados filtrados e paginados das empresas a serem exibidos.
         */
        function renderEmpresas(data) {
            const tbody = document.querySelector('#empresasTable tbody');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Nenhuma empresa encontrada.</td></tr>';
                return;
            }

            data.forEach(empresa => {
                const row = tbody.insertRow();
                row.insertCell().textContent = empresa.CNPJ || '';
                row.insertCell().textContent = empresa.NOME || '';
                row.insertCell().textContent = empresa.PROPRIETARIO || '';
                row.insertCell().textContent = empresa.STATUS || '';

                const actionsCell = row.insertCell();
                actionsCell.className = 'action-buttons';
                // Adicionando event listeners aos botões de ação
                actionsCell.innerHTML = `
                    <button title="Visualizar" data-cnpj="${empresa.CNPJ}" onclick="viewCompany('${empresa.CNPJ}')"><i class="fas fa-eye"></i></button>
                    <button title="Editar" data-cnpj="${empresa.CNPJ}" onclick="editCompany('${empresa.CNPJ}')"><i class="fas fa-pencil-alt"></i></button>
                    <button title="Deletar" data-cnpj="${empresa.CNPJ}" onclick="deleteCompany('${empresa.CNPJ}')"><i class="fas fa-trash-alt"></i></button>
                `;
            });
        }

        /**
         * Atualiza os controles de paginação para uma aba específica.
         * @param {string} tabName O nome da aba ('usuarios' ou 'empresas').
         * @param {Array<Object>} filteredData Os dados filtrados (mas não paginados) para a aba.
         * @param {number} currentPage A página atual.
         */
        function updatePagination(tabName, filteredData, currentPage) {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const paginationInfoElement = document.getElementById(`${tabName}PaginationInfo`);
            const pageNumbersContainer = document.getElementById(`${tabName}PageNumbers`);

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredData.length);
            if (filteredData.length > 0) {
                paginationInfoElement.textContent = `Mostrando ${startIndex + 1} a ${endIndex} de ${filteredData.length} resultados`;
            } else {
                paginationInfoElement.textContent = `Mostrando 0 a 0 de 0 resultados`;
            }

            pageNumbersContainer.innerHTML = '';

            for (let i = 1; i <= totalPages; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.onclick = () => goToPage(tabName, i);
                if (i === currentPage) {
                    button.classList.add('active');
                }
                pageNumbersContainer.appendChild(button);
            }

            const prevButton = document.querySelector(`#${tabName}Pagination button:first-of-type`);
            const nextButton = document.querySelector(`#${tabName}Pagination button:last-of-type`);

            if (prevButton) prevButton.disabled = currentPage === 1 || totalPages === 0;
            if (nextButton) nextButton.disabled = currentPage === totalPages || totalPages === 0;
        }

        /**
         * Aplica filtros e navega para uma página específica, renderizando os dados.
         * Esta é a função principal chamada por eventos de filtro, pesquisa e paginação.
         * @param {string} tabName O nome da aba ('usuarios' ou 'empresas').
         * @param {number} pageNumber O número da página para navegar.
         */
        function applyFiltersAndGoToPage(tabName, pageNumber) {
            let dataToFilter;
            let searchTerm;
            let statusFilter;
            let currentPageVar;

            if (tabName === 'usuarios') {
                dataToFilter = allUsuariosData;
                searchTerm = document.getElementById('searchUserInput').value;
                statusFilter = document.getElementById('statusUserFilter').value;
                currentPageVar = currentPageUsuarios;
            } else if (tabName === 'empresas') {
                dataToFilter = allEmpresasData;
                searchTerm = document.getElementById('searchCompanyInput').value;
                statusFilter = document.getElementById('statusCompanyFilter').value;
                currentPageVar = currentPageEmpresas;
            }

            const filteredData = filterData(dataToFilter, searchTerm, statusFilter, tabName);

            // Garante que a página não exceda o total de páginas após a filtragem
            const totalPagesAfterFilter = Math.ceil(filteredData.length / itemsPerPage);
            const newPageNumber = Math.max(1, Math.min(pageNumber, totalPagesAfterFilter === 0 ? 1 : totalPagesAfterFilter));

            if (tabName === 'usuarios') {
                currentPageUsuarios = newPageNumber;
            } else if (tabName === 'empresas') {
                currentPageEmpresas = newPageNumber;
            }

            const startIndex = (newPageNumber - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedData = filteredData.slice(startIndex, endIndex);

            if (tabName === 'usuarios') {
                renderUsuarios(paginatedData);
                updatePagination('usuarios', filteredData, currentPageUsuarios);
            } else if (tabName === 'empresas') {
                renderEmpresas(paginatedData);
                updatePagination('empresas', filteredData, currentPageEmpresas);
            }
        }

        /**
         * Função wrapper para goToPage, para ser usada em onclick dos botões de paginação.
         * Simplesmente chama applyFiltersAndGoToPage com a página desejada.
         * @param {string} tabName
         * @param {number} pageNumber
         */
        function goToPage(tabName, pageNumber) {
            applyFiltersAndGoToPage(tabName, pageNumber);
        }

        // Referências aos elementos do modal de usuário
        const userModal = document.getElementById('userModal');
        const cancelUserModalButton = document.getElementById('cancelUserModal');
        const userForm = document.getElementById('userForm');
        const modalUserIdInput = document.getElementById('modalUserId'); // Novo campo oculto para ID
        const modalUsuarioInput = document.getElementById('modalUsuario');
        const modalNomeInput = document.getElementById('modalNome');
        const modalEmpresaSelect = document.getElementById('modalEmpresaSelect');
        const modalAutenticacaoSelect = document.getElementById('modalAutenticacao');
        const modalAcessoSelect = document.getElementById('modalAcesso');
        const modalSenhaInput = document.getElementById('modalSenha');
        const userModalTitle = document.getElementById('userModalTitle');
        const submitUserFormButton = document.getElementById('submitUserFormButton');
        const modalErrorMessage = document.getElementById('modalErrorMessage');
        const modalSuccessMessage = document.getElementById('modalSuccessMessage');
        const modalLoadingMessage = document.getElementById('modalLoadingMessage');

        // Referências aos elementos do modal de empresa
        const companyModal = document.getElementById('companyModal');
        const cancelCompanyModalButton = document.getElementById('cancelCompanyModal');
        const companyForm = document.getElementById('companyForm');
        const modalCompanyCnpjInput = document.getElementById('modalCompanyCnpj'); // Campo oculto para CNPJ original
        const modalCnpjInput = document.getElementById('modalCnpj');
        const modalCompanyNameInput = document.getElementById('modalCompanyName');
        const modalCompanyInscricaoEstadualInput = document.getElementById('modalCompanyInscricaoEstadual');
        const modalCompanyDataAberturaInput = document.getElementById('modalCompanyDataAbertura');
        const modalCompanyEmailInput = document.getElementById('modalCompanyEmail');
        const modalCompanyCepInput = document.getElementById('modalCompanyCep');
        const modalCompanyEnderecoInput = document.getElementById('modalCompanyEndereco');
        const modalCompanyNumeroInput = document.getElementById('modalCompanyNumero');
        const modalCompanyBairroInput = document.getElementById('modalCompanyBairro');
        const modalCompanyCidadeInput = document.getElementById('modalCompanyCidade');
        const modalCompanyEstadoInput = document.getElementById('modalCompanyEstado');
        const modalCompanyTelefoneInput = document.getElementById('modalCompanyTelefone');
        const modalCompanyOwnerInput = document.getElementById('modalCompanyOwner');
        const modalCompanyStatusSelect = document.getElementById('modalCompanyStatus');
        const companyModalTitle = document.getElementById('companyModalTitle');
        const submitCompanyFormButton = document.getElementById('submitCompanyFormButton');
        const companyModalErrorMessage = document.getElementById('companyModalErrorMessage');
        const companyModalSuccessMessage = document.getElementById('companyModalSuccessMessage');
        const companyModalLoadingMessage = document.getElementById('companyModalLoadingMessage');

        // Referências para o modal de confirmação genérico
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmationMessage = document.getElementById('confirmationMessage');
        const cancelConfirmationButton = document.getElementById('cancelConfirmation');
        const confirmActionButton = document.getElementById('confirmAction');
        let currentConfirmAction = null; // Armazena a função a ser executada na confirmação

        // Referência ao botão "Voltar"
        const backButton = document.getElementById('backButton');

        /**
         * Exibe uma mensagem de erro em um elemento específico.
         * @param {HTMLElement} element O elemento HTML onde a mensagem será exibida.
         * @param {string} message A mensagem de erro.
         */
        function showMessage(element, message, type) {
            element.textContent = message;
            element.classList.remove('hidden', 'error', 'success', 'loading');
            element.classList.add(type);
        }

        /**
         * Oculta uma mensagem em um elemento específico.
         * @param {HTMLElement} element O elemento HTML da mensagem.
         */
        function hideMessage(element) {
            element.classList.add('hidden');
            element.textContent = '';
        }

        /**
         * Popula o select de empresas com os nomes das empresas cadastradas.
         * @param {string} [selectedValue] O valor a ser pré-selecionado (opcional).
         */
        function populateEmpresasSelect(selectedValue = '') {
            modalEmpresaSelect.innerHTML = '<option value="">Selecione uma empresa</option>'; // Limpa e adiciona opção padrão
            const uniqueCompanyNames = [...new Set(allEmpresasData.map(empresa => empresa.NOME).filter(name => name))];
            uniqueCompanyNames.sort().forEach(name => { // Opcional: ordena alfabeticamente
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                modalEmpresaSelect.appendChild(option);
            });

            if (selectedValue) {
                modalEmpresaSelect.value = selectedValue;
            } else if (currentUserCompany && uniqueCompanyNames.includes(currentUserCompany)) {
                // Se nenhum valor foi passado e o usuário atual tem empresa, pré-seleciona
                modalEmpresaSelect.value = currentUserCompany;
            }
        }

        /**
         * Popula o select de acesso com TODOS os tipos de acesso da aba 'Permissões'.
         * @param {string} [selectedValue] O valor a ser pré-selecionado (opcional).
         */
        function populateAcessoSelect(selectedValue = '') {
            modalAcessoSelect.innerHTML = '<option value="">Selecione um tipo de acesso</option>'; // Limpa e adiciona opção padrão

            const allAccessTypes = allPermissoesData
                .map(perm => perm['TIPO DE ACESSO'])
                .filter(type => type);

            const uniqueAccessTypes = [...new Set(allAccessTypes)].sort();

            uniqueAccessTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                modalAcessoSelect.appendChild(option);
            });

            if (selectedValue) {
                modalAcessoSelect.value = selectedValue;
            }
        }

        /**
         * Abre o modal de cadastro/edição de usuário.
         * @param {Object} [userData] Dados do usuário para preencher o formulário (para edição).
         */
        function openUserModal(userData = null) {
            userModal.classList.add('active');
            document.body.style.overflow = 'hidden';
            userForm.reset();
            modalSenhaInput.value = "";
            hideMessage(modalErrorMessage);
            hideMessage(modalSuccessMessage);
            hideMessage(modalLoadingMessage);

            if (userData) {
                userModalTitle.textContent = 'Editar Usuário';
                submitUserFormButton.textContent = 'Atualizar';
                modalUserIdInput.value = userData.ID || '';
                modalUsuarioInput.value = userData.ID || ''; // ID é o usuário
                modalNomeInput.value = userData['NOME/EQUIPE'] || '';
                modalAutenticacaoSelect.value = userData['AUTENTICAÇÃO'] || 'NÃO';
                modalSenhaInput.value = userData.SENHA || ''; // Mantém a senha existente
                modalSenhaInput.readOnly = true; // Senha não editável diretamente
                modalSenhaInput.classList.add('bg-gray-100', 'cursor-not-allowed');
                populateEmpresasSelect(userData.EMPRESA);
                populateAcessoSelect(userData.ACESSO);
            } else {
                userModalTitle.textContent = 'Cadastrar Usuário';
                submitUserFormButton.textContent = 'Salvar';
                modalUserIdInput.value = ''; // Garante que o ID esteja vazio para novo cadastro
                modalSenhaInput.readOnly = false; // Senha editável para novo cadastro
                modalSenhaInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
                populateEmpresasSelect(); // Popula sem pré-seleção
                populateAcessoSelect(); // Popula sem pré-seleção
            }
        }

        /**
         * Fecha o modal de usuário.
         */
        function closeUserModal() {
            userModal.classList.remove('active');
            document.body.style.overflow = '';
            userForm.reset();
            hideMessage(modalErrorMessage);
            hideMessage(modalSuccessMessage);
            hideMessage(modalLoadingMessage);
            modalEmpresaSelect.innerHTML = '<option value="">Selecione uma empresa</option>';
            modalAcessoSelect.innerHTML = '<option value="">Selecione um tipo de acesso</option>';
            // Reabilita o botão de salvar caso tenha sido escondido pela visualização
            submitUserFormButton.classList.remove('hidden');
            userForm.querySelectorAll('input, select').forEach(field => {
                field.disabled = false; // Reabilita todos os campos
            });
            modalUsuarioInput.readOnly = false; // Reabilita edição do ID para novos cadastros
            modalUsuarioInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
        }

        /**
         * Abre o modal de cadastro/edição de empresa.
         * @param {Object} [companyData] Dados da empresa para preencher o formulário (para edição).
         */
        function openCompanyModal(companyData = null) {
            companyModal.classList.add('active');
            document.body.style.overflow = 'hidden';
            companyForm.reset();
            hideMessage(companyModalErrorMessage);
            hideMessage(companyModalSuccessMessage);
            hideMessage(companyModalLoadingMessage);

            if (companyData) {
                companyModalTitle.textContent = 'Editar Empresa';
                submitCompanyFormButton.textContent = 'Atualizar';
                modalCompanyCnpjInput.value = companyData.CNPJ || ''; // CNPJ original para busca
                modalCnpjInput.value = companyData.CNPJ || '';
                modalCompanyNameInput.value = companyData.NOME || '';
                modalCompanyInscricaoEstadualInput.value = companyData['INSCRIÇÃO ESTADUAL'] || '';
                modalCompanyDataAberturaInput.value = companyData['DATA DE ABERTURA'] ? new Date(companyData['DATA DE ABERTURA']).toISOString().split('T')[0] : ''; // Formata para input type="date"
                modalCompanyEmailInput.value = companyData['E-MAIL'] || '';
                modalCompanyCepInput.value = companyData.CEP || '';
                modalCompanyEnderecoInput.value = companyData.ENDERECO || '';
                modalCompanyNumeroInput.value = companyData.NUMERO || '';
                modalCompanyBairroInput.value = companyData.BAIRRO || '';
                modalCompanyCidadeInput.value = companyData.CIDADE || '';
                modalCompanyEstadoInput.value = companyData.ESTADO || '';
                modalCompanyTelefoneInput.value = companyData.TELEFONE || '';
                modalCompanyOwnerInput.value = companyData.PROPRIETARIO || '';
                modalCompanyStatusSelect.value = companyData.STATUS || 'Ativa';
                modalCnpjInput.readOnly = true; // CNPJ não editável em edição
                modalCnpjInput.classList.add('bg-gray-100', 'cursor-not-allowed');
            } else {
                companyModalTitle.textContent = 'Cadastrar Empresa';
                submitCompanyFormButton.textContent = 'Salvar';
                modalCompanyCnpjInput.value = ''; // Garante que esteja vazio
                modalCnpjInput.readOnly = false; // CNPJ editável para novo cadastro
                modalCnpjInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
            }
        }

        /**
         * Fecha o modal de empresa.
         */
        function closeCompanyModal() {
            companyModal.classList.remove('active');
            document.body.style.overflow = '';
            companyForm.reset();
            hideMessage(companyModalErrorMessage);
            hideMessage(companyModalSuccessMessage);
            hideMessage(companyModalLoadingMessage);
            // Reabilita o botão de salvar caso tenha sido escondido pela visualização
            submitCompanyFormButton.classList.remove('hidden');
            companyForm.querySelectorAll('input, select').forEach(field => {
                field.disabled = false; // Reabilita todos os campos
            });
            modalCnpjInput.readOnly = false; // Reabilita edição do CNPJ para novos cadastros
            modalCnpjInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
        }

        /**
         * Exibe o modal de confirmação.
         * @param {string} message Mensagem a ser exibida.
         * @param {Function} onConfirm Callback a ser executado se o usuário confirmar.
         */
        function showConfirmationModal(message, onConfirm) {
            confirmationMessage.textContent = message;
            currentConfirmAction = onConfirm;
            confirmationModal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        /**
         * Fecha o modal de confirmação.
         */
        function closeConfirmationModal() {
            confirmationModal.classList.remove('active');
            document.body.style.overflow = '';
            currentConfirmAction = null;
        }

        /**
         * Envia dados para o Google Apps Script via POST.
         * @param {Object} data Os dados a serem enviados.
         * @param {HTMLElement} loadingEl Elemento para exibir loading.
         * @param {HTMLElement} errorEl Elemento para exibir erro.
         * @param {HTMLElement} successEl Elemento para exibir sucesso.
         * @returns {Promise<Object>} A resposta do script.
         */
        async function sendDataToAppsScript(data, loadingEl, errorEl, successEl) {
            hideMessage(errorEl);
            hideMessage(successEl);
            showMessage(loadingEl, 'Processando...', 'loading');

            try {
                console.log('DEBUG: Tentando enviar dados para Apps Script.');
                console.log('DEBUG: URL:', APPS_SCRIPT_URL);
                console.log('DEBUG: Dados enviados:', JSON.stringify(data));

                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                    mode: 'cors' // Explicitly set CORS mode
                });

                if (!response.ok) {
                    let errorDetails = `Erro HTTP: ${response.status} - ${response.statusText}`;
                    try {
                        const errorJson = await response.json();
                        errorDetails += `. Detalhes: ${JSON.stringify(errorJson)}`;
                    } catch (e) {
                        const errorText = await response.text();
                        errorDetails += `. Detalhes: ${errorText.substring(0, 200)}...`;
                    }
                    throw new Error(errorDetails);
                }

                const result = await response.json();

                if (result.status === 'sucesso') {
                    showMessage(successEl, result.message, 'success');
                    return result; // Retorna o resultado para que o chamador possa agir
                } else {
                    throw new Error(result.message || 'Erro desconhecido retornado pelo script.');
                }
            } catch (error) {
                console.error('Erro na requisição ao Apps Script:', error);
                showMessage(errorEl, `Erro: ${error.message}`, 'error');
                return { status: 'erro', message: error.message }; // Retorna um objeto de erro
            } finally {
                hideMessage(loadingEl);
            }
        }

        /**
         * Função para lidar com a visualização de detalhes de um usuário.
         * @param {string} userId O ID do usuário a ser visualizado.
         */
        function viewUser(userId) {
            const user = allUsuariosData.find(u => u.ID === userId);
            if (user) {
                openUserModal(user); // Abre o modal em modo de edição/visualização
                userModalTitle.textContent = 'Detalhes do Usuário';
                submitUserFormButton.classList.add('hidden'); // Esconde o botão Salvar/Atualizar
                // Desativa todos os campos para visualização
                userForm.querySelectorAll('input, select').forEach(field => {
                    field.disabled = true;
                });
                // Apenas o botão de cancelar deve estar visível
                cancelUserModalButton.classList.remove('hidden');

            } else {
                console.error('Usuário não encontrado para visualização:', userId);
                // Poderia exibir uma mensagem de erro na tela
            }
        }

        /**
         * Função para lidar com a edição de um usuário.
         * @param {string} userId O ID do usuário a ser editado.
         */
        function editUser(userId) {
            const user = allUsuariosData.find(u => u.ID === userId);
            if (user) {
                openUserModal(user);
                submitUserFormButton.classList.remove('hidden'); // Garante que o botão Salvar/Atualizar esteja visível
                userForm.querySelectorAll('input, select').forEach(field => {
                    field.disabled = false; // Reabilita campos para edição
                });
                modalUsuarioInput.readOnly = true; // ID do usuário não deve ser alterado
                modalUsuarioInput.classList.add('bg-gray-100', 'cursor-not-allowed');
            } else {
                console.error('Usuário não encontrado para edição:', userId);
            }
        }

        /**
         * Função para lidar com a exclusão de um usuário.
         * @param {string} userId O ID do usuário a ser excluído.
         */
        function deleteUser(userId) {
            const user = allUsuariosData.find(u => u.ID === userId);
            if (user) {
                showConfirmationModal(`Tem certeza que deseja deletar o usuário "${user['NOME/EQUIPE']}" (ID: ${user.ID})?`, async () => {
                    closeConfirmationModal(); // Fecha o modal de confirmação
                    const dataToSend = {
                        action: 'deleteUser',
                        id: userId
                    };
                    const result = await sendDataToAppsScript(dataToSend, modalLoadingMessage, modalErrorMessage, modalSuccessMessage);
                    if (result.status === 'sucesso') {
                        // Recarrega os dados após a exclusão bem-sucedida
                        await initializeDashboard();
                        // Opcional: exibir mensagem de sucesso por um tempo e depois esconder
                        setTimeout(() => hideMessage(modalSuccessMessage), 3000);
                    }
                });
            } else {
                console.error('Usuário não encontrado para exclusão:', userId);
            }
        }

        /**
         * Função para lidar com a visualização de detalhes de uma empresa.
         * @param {string} cnpj O CNPJ da empresa a ser visualizada.
         */
        function viewCompany(cnpj) {
            const company = allEmpresasData.find(c => c.CNPJ === cnpj);
            if (company) {
                openCompanyModal(company);
                companyModalTitle.textContent = 'Detalhes da Empresa';
                submitCompanyFormButton.classList.add('hidden');
                companyForm.querySelectorAll('input, select').forEach(field => {
                    field.disabled = true;
                });
                cancelCompanyModalButton.classList.remove('hidden');
            } else {
                console.error('Empresa não encontrada para visualização:', cnpj);
            }
        }

        /**
         * Função para lidar com a edição de uma empresa.
         * @param {string} cnpj O CNPJ da empresa a ser editada.
         */
        function editCompany(cnpj) {
            const company = allEmpresasData.find(c => c.CNPJ === cnpj);
            if (company) {
                openCompanyModal(company);
                submitCompanyFormButton.classList.remove('hidden');
                companyForm.querySelectorAll('input, select').forEach(field => {
                    field.disabled = false;
                });
                modalCnpjInput.readOnly = true; // CNPJ não deve ser alterado
                modalCnpjInput.classList.add('bg-gray-100', 'cursor-not-allowed');
            } else {
                console.error('Empresa não encontrada para edição:', cnpj);
            }
        }

        /**
         * Função para lidar com a exclusão de uma empresa.
         * @param {string} cnpj O CNPJ da empresa a ser excluída.
         */
        function deleteCompany(cnpj) {
            const company = allEmpresasData.find(c => c.CNPJ === cnpj);
            if (company) {
                showConfirmationModal(`Tem certeza que deseja deletar a empresa "${company.NOME}" (CNPJ: ${company.CNPJ})?`, async () => {
                    closeConfirmationModal(); // Fecha o modal de confirmação
                    const dataToSend = {
                        action: 'deleteCompany',
                        cnpj: cnpj
                    };
                    const result = await sendDataToAppsScript(dataToSend, companyModalLoadingMessage, companyModalErrorMessage, companyModalSuccessMessage);
                    if (result.status === 'sucesso') {
                        await initializeDashboard();
                        setTimeout(() => hideMessage(companyModalSuccessMessage), 3000);
                    }
                });
            } else {
                console.error('Empresa não encontrada para exclusão:', cnpj);
            }
        }

        /**
         * Carrega os dados do usuário do localStorage e inicializa o painel.
         * Não há redirecionamento se os dados estiverem ausentes.
         */
        async function initializeDashboard() {
            userInfoElement(); // Tenta carregar e exibir as informações do usuário

            const loadingUsuarios = document.getElementById('loadingUsuarios');
            const errorUsuarios = document.getElementById('errorUsuarios');
            const loadingEmpresas = document.getElementById('loadingEmpresas');
            const errorEmpresas = document.getElementById('errorEmpresas');
            // Reutilizando elementos de loading/erro para Permissões, pois não tem um display dedicado
            const loadingPermissoes = document.getElementById('loadingUsuarios');
            const errorPermissoes = document.getElementById('errorUsuarios');

            // Carrega todos os dados
            allUsuariosData = await fetchData('Usuarios', loadingUsuarios, errorUsuarios);
            allEmpresasData = await fetchData('Empresas', loadingEmpresas, errorEmpresas);
            allPermissoesData = await fetchData('Permissões', loadingPermissoes, errorPermissoes);

            // Garante que a aba de usuários é a primeira a ser mostrada e renderizada
            showTab('usuarios');
        }

        // Adiciona event listeners para os campos de pesquisa e filtros de status
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('searchUserInput').addEventListener('input', () => applyFiltersAndGoToPage('usuarios', 1));
            document.getElementById('statusUserFilter').addEventListener('change', () => applyFiltersAndGoToPage('usuarios', 1));

            document.getElementById('searchCompanyInput').addEventListener('input', () => applyFiltersAndGoToPage('empresas', 1));
            document.getElementById('statusCompanyFilter').addEventListener('change', () => applyFiltersAndGoToPage('empresas', 1));

            // Event listeners para o modal de usuário
            addUsuarioButton.addEventListener('click', () => openUserModal(null)); // Abre para novo cadastro
            cancelUserModalButton.addEventListener('click', closeUserModal);
            userModal.addEventListener('click', (e) => {
                if (e.target === userModal) {
                    closeUserModal();
                }
            });

            // Event listener para o campo USUÁRIO para preencher a SENHA dinamicamente
            modalUsuarioInput.addEventListener('input', () => {
                // Preenche a senha apenas se for um novo cadastro (modalUserIdInput.value está vazio)
                if (!modalUserIdInput.value && modalUsuarioInput.value.trim() !== "") {
                    modalSenhaInput.value = modalUsuarioInput.value + "@MudarSenha1999";
                } else if (!modalUserIdInput.value) { // Se o campo usuário for limpo em novo cadastro
                    modalSenhaInput.value = "";
                }
            });

            // Lidar com o envio do formulário de usuário
            userForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                hideMessage(modalErrorMessage);
                hideMessage(modalSuccessMessage);

                const formData = new FormData(userForm);
                const userData = {};
                userData.id = formData.get('id'); // Pode ser vazio para novo cadastro
                userData.usuario = formData.get('usuario');
                userData.nome = formData.get('nome');
                userData.empresa = formData.get('empresa');
                userData.autenticacao = formData.get('autenticacao');
                userData.acesso = formData.get('acesso');
                userData.senha = formData.get('senha');

                // Regra de Validação: Cadastrar Master System
                if (userData.acesso === "Master System" && currentUserAccess !== "Master System") {
                    showMessage(modalErrorMessage, 'Erro: Somente usuários "Master System" podem cadastrar outros usuários "Master System".', 'error');
                    return;
                }

                // Determina a ação (criar ou atualizar)
                const action = userData.id ? 'updateUser' : 'createUser';
                const dataToSend = { action: action, ...userData };

                const result = await sendDataToAppsScript(dataToSend, modalLoadingMessage, modalErrorMessage, modalSuccessMessage);

                if (result.status === 'sucesso') {
                    // Recarrega os dados e fecha o modal após um pequeno atraso para o usuário ver a mensagem de sucesso
                    setTimeout(async () => {
                        closeUserModal();
                        await initializeDashboard();
                    }, 1500);
                }
            });

            // Event listeners para o modal de empresa
            addCompanyButton.addEventListener('click', () => openCompanyModal(null));
            cancelCompanyModalButton.addEventListener('click', closeCompanyModal);
            companyModal.addEventListener('click', (e) => {
                if (e.target === companyModal) {
                    closeCompanyModal();
                }
            });

            // Lidar com o envio do formulário de empresa
            companyForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                hideMessage(companyModalErrorMessage);
                hideMessage(companyModalSuccessMessage);

                const formData = new FormData(companyForm);
                const companyData = {};
                companyData.cnpjOriginal = formData.get('cnpjOriginal'); // CNPJ original para edição
                companyData.cnpj = formData.get('cnpj');
                companyData.nome = formData.get('nome');
                companyData.inscricaoEstadual = formData.get('inscricaoEstadual');
                companyData.dataAbertura = formData.get('dataAbertura');
                companyData.email = formData.get('email');
                companyData.cep = formData.get('cep');
                companyData.endereco = formData.get('endereco');
                companyData.numero = formData.get('numero');
                companyData.bairro = formData.get('bairro');
                companyData.cidade = formData.get('cidade');
                companyData.estado = formData.get('estado');
                companyData.telefone = formData.get('telefone');
                companyData.proprietario = formData.get('proprietario');
                companyData.status = formData.get('status');

                // Determina a ação (criar ou atualizar)
                const action = companyData.cnpjOriginal ? 'updateCompany' : 'createCompany';
                const dataToSend = { action: action, ...companyData };

                const result = await sendDataToAppsScript(dataToSend, companyModalLoadingMessage, companyModalErrorMessage, companyModalSuccessMessage);

                if (result.status === 'sucesso') {
                    setTimeout(async () => {
                        closeCompanyModal();
                        await initializeDashboard();
                    }, 1500);
                }
            });

            // Event listeners para o modal de confirmação
            confirmActionButton.addEventListener('click', () => {
                if (currentConfirmAction) {
                    currentConfirmAction();
                }
            });
            cancelConfirmationButton.addEventListener('click', closeConfirmationModal);
            confirmationModal.addEventListener('click', (e) => {
                if (e.target === confirmationModal) {
                    closeConfirmationModal();
                }
            });


            // Event listener para o botão "Voltar"
            backButton.addEventListener('click', () => {
                window.location.href = "dashboard.html";
            });

            // Executa quando a página é totalmente carregada
            initializeDashboard();
        });
    </script>
</body>
</html>
